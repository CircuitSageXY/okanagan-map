<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Okanagan Route Planner</title>

<!-- Google icons -->
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

<style>
/* … (all your existing CSS is unchanged) … */
</style>

<!-- ── 1. stub so Google always finds a callback ── -->
<script>
  function init(){
    if(typeof window.routePlannerInit==='function'){ window.routePlannerInit(); }
    else{ window.__mapsApiReady=true; }
  }
</script>

<!-- Google Maps -->
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDnpSCHQWHr1neHALY-xddNne_S7f608co&callback=init&libraries=places,geometry">
</script>

<!-- SortableJS -->
<script type="module" src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/modular/sortable.core.esm.js"></script>
</head>
<body>

<div id="timelineDock"><iframe src="TimeFrames.html" title="TimeFrames" loading="lazy"></iframe></div>

<div id="panel">
  <div id="stops"></div>
  <button id="add">+ Add stop</button>
  <button id="route">Route</button>
  <button id="opt">Optimize</button>
  <div id="msg"></div>
</div>

<div id="map"></div>

<!-- ── 2. main planner ── -->
<script type="module">
import Sortable from 'https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/+esm';

const labels='ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
const colourCycle=['A','B','C','D','E','F','G','H'];

let map,dirSvc,dirRend,geocoder,acService,placeSvc;
let autoTimer=null,routeVersion=0,previewPins=[];
let optimizerBusy=false;          /* ✱ NEW – flag to lock the button */

/* ───── geometry helpers (unchanged) ───── */
const IHA_POLY=[{lat:53.40,lng:-118.50},{lat:53.50,lng:-122.00},{lat:52.50,lng:-123.00},
 {lat:51.00,lng:-123.00},{lat:50.10,lng:-123.20},{lat:49.80,lng:-122.40},
 {lat:49.00,lng:-120.00},{lat:49.00,lng:-114.00},{lat:51.20,lng:-114.00},
 {lat:53.00,lng:-116.00}];
function insidePoly(pt,poly){
  let c=false,j=poly.length-1;
  for(let i=0;i<poly.length;i++){
    const pi=poly[i],pj=poly[j];
    if(((pi.lng>pt.lng)!=(pj.lng>pt.lng)) &&
        pt.lat<(pj.lat-pi.lat)*(pt.lng-pi.lng)/(pj.lng-pi.lng)+pi.lat) c=!c;
    j=i;
  }
  return c;
}
const CENTRAL_OK_BOUNDS={south:49.60,north:50.30,west:-120.20,east:-118.90};
const CENTRAL_OK_RX=/kelowna|west kelowna|lake country|oyama|peachland|fintry|joe rich|ellison|rutland|glenmore|glenrosa/i;

/* smart geocoder (unchanged) */
function geocodeSmart(text){
  const cleaned=text.replace(/\s+/g,' ').trim();
  if(!cleaned) return Promise.resolve(null);
  return new Promise(res=>{
    acService.getPlacePredictions({
      input:cleaned,bounds:CENTRAL_OK_BOUNDS,
      componentRestrictions:{country:'ca'},types:['address']
    },(preds,status)=>{
      if(status===google.maps.places.PlacesServiceStatus.OK && preds?.length){
        const pred=preds.find(p=>CENTRAL_OK_RX.test(p.description))||preds[0];
        placeSvc.getDetails({placeId:pred.place_id,fields:['formatted_address','geometry']},
          (plc,stat2)=>{
            if(stat2===google.maps.places.PlacesServiceStatus.OK && plc?.geometry){
              const loc=plc.geometry.location;
              return res({lat:loc.lat(),lng:loc.lng(),formatted:plc.formatted_address});
            }
            geoFallback();
          });
      }else{ geoFallback(); }
    });
    function geoFallback(){
      geocoder.geocode(
        {address:`${cleaned}, BC, Canada`,componentRestrictions:{country:'ca'}},
        (r,s)=>{
          if(s==='OK' && r[0]){
            const loc=r[0].geometry.location;
            res({lat:loc.lat(),lng:loc.lng(),formatted:r[0].formatted_address});
          }else{ res(null); }
        });
    }
  });
}

/* batch geocode */
const ensureCoords=rows=>{
  const tasks=rows.map(row=>{
    const inp=row.querySelector('.stop');
    row.classList.remove('invalid');
    if(!inp.value){                 /* ✱ CHG – quick exit if empty */
      inp.dataset.lat='';inp.dataset.lng='';
      return;
    }
    if(inp.dataset.lat && inp.dataset.lng) return;
    return geocodeSmart(inp.value).then(out=>{
      if(out){
        inp.dataset.lat=out.lat; inp.dataset.lng=out.lng; inp.value=out.formatted;
      }else{ row.classList.add('invalid'); inp.placeholder='Unrecognised – edit me'; }
    });
  });
  return Promise.all(tasks);
};

/* DOM helpers */
function makeRow(i){
  const d=document.createElement('div'); d.className='row';
  const clr=colourCycle[i%colourCycle.length]||'defaultBullet';
  d.innerHTML=`
    <div class="bullet ${clr}">${labels[i]}</div>
    <input class="stop" placeholder="Enter stop">
    <span class="material-icons drag" title="Drag to reorder">drag_indicator</span>
    <span class="remove" title="Remove stop">×</span>`;
  d.querySelector('.remove').onclick=()=>{d.remove();renumber();autoCompute();};
  return d;
}
function renumber(){
  [...document.querySelectorAll('.row')].forEach((r,i)=>{
    const b=r.querySelector('.bullet');
    b.textContent=labels[i]||'?';
    b.className='bullet '+(colourCycle[i%colourCycle.length]||'defaultBullet');
  });
}
const clearPreviewPins=()=>{previewPins.forEach(m=>m.setMap(null));previewPins=[];};
const addPreviewPin=(pos,label)=>previewPins.push(new google.maps.Marker(
  {map,position:pos,label:{text:label,color:'#fff'}}));
const clearLegDisplays=()=>document.querySelectorAll('.leg-display').forEach(e=>e.remove());
const markRowFocus=(input,focus)=>{
  const row=input.closest('.row'); if(!row) return;
  row.classList.toggle('focused',focus);
};

/* ✱ NEW – helper that *fully* wipes the previous Google route (path + A/B markers) */
function clearDirections(){
  if(dirRend){
    dirRend.setMap(null);          // detach renderer (removes markers)
    dirRend.set('directions',null);
  }
}

/* prediction filter (unchanged) */
function installPredictionFilter(){
  new MutationObserver(muts=>{
    muts.forEach(m=>m.addedNodes.forEach(node=>{
      if(node.nodeType!==1||!node.classList.contains('pac-item'))return;
      const txt=node.textContent;
      requestAnimationFrame(()=>{
        const container=node.parentElement;if(!container) return;
        const allowed=CENTRAL_OK_RX.test(txt);
        if(allowed){node.style.display='';node.classList.add('pac-central-ok');}
        else{
          const hasAllowed=[...container.children].some(ch=>CENTRAL_OK_RX.test(ch.textContent));
          if(hasAllowed) node.style.display='none';
          else{node.style.display='';node.style.opacity=.45;}
        }
      });
    }));
  }).observe(document.body,{childList:true,subtree:true});
}

/* TAB helper */
function focusNextStop(curInput){
  const stops=[...document.querySelectorAll('input.stop')];
  const i=stops.indexOf(curInput);
  if(i>-1 && stops[i+1]){stops[i+1].focus();return;}
  const addBtn=document.getElementById('add');
  if(addBtn && document.getElementById('stops').children.length<labels.length){
    addBtn.click();
    requestAnimationFrame(()=>[...document.querySelectorAll('input.stop')].pop()?.focus());
  }
}

/* accept top prediction */
function acceptTopPrediction(inp){
  const q=inp.value.trim(); if(!q){focusNextStop(inp);return;}
  acService.getPlacePredictions({
    input:q,bounds:CENTRAL_OK_BOUNDS,componentRestrictions:{country:'ca'},types:['address']
  },(preds,status)=>{
    if(status!==google.maps.places.PlacesServiceStatus.OK||!preds?.length){focusNextStop(inp);return;}
    const pred=preds.find(p=>CENTRAL_OK_RX.test(p.description))||preds[0];
    placeSvc.getDetails({placeId:pred.place_id,fields:['formatted_address','geometry']},
      (plc,stat2)=>{
        if(stat2!==google.maps.places.PlacesServiceStatus.OK||!plc?.geometry){focusNextStop(inp);return;}
        const loc=plc.geometry.location,pt={lat:loc.lat(),lng:loc.lng()};
        if(!insidePoly(pt,IHA_POLY)){
          inp.value='';inp.placeholder='Outside Interior Health';
          setTimeout(()=>{if(!inp.value)inp.placeholder='Enter stop';},3000);
          focusNextStop(inp);return;
        }
        inp.value=plc.formatted_address||pred.description;
        inp.dataset.lat=pt.lat;inp.dataset.lng=pt.lng;
        autoCompute();focusNextStop(inp);
      });
  });
}

/* ── initialiser ── */
window.routePlannerInit=()=>{
  installPredictionFilter();

  map=new google.maps.Map(document.getElementById('map'),{center:{lat:49.8879,lng:-119.4960},zoom:10});
  new google.maps.KmlLayer({
    url:'https://circuitsagexy.github.io/okanagan-map/r5a1LjX92e-djkvc12df/okanagan.kmz',
    map,preserveViewport:true
  });

  dirSvc=new google.maps.DirectionsService();
  dirRend=new google.maps.DirectionsRenderer({map});
  geocoder=new google.maps.Geocoder();
  acService=new google.maps.places.AutocompleteService();
  placeSvc=new google.maps.places.PlacesService(map);

  const list=document.getElementById('stops');
  list.appendChild(makeRow(0)); list.appendChild(makeRow(1));
  Sortable.create(list,{handle:'.drag',animation:150,onEnd:()=>{renumber();autoCompute();}});

  const acOpts={
    fields:['formatted_address','geometry','place_id'],types:['address'],
    componentRestrictions:{country:'ca'},bounds:CENTRAL_OK_BOUNDS,strictBounds:true
  };

  const attach=input=>{
    const ph='Enter stop'; input.placeholder=ph;

    /* focus / blur */
    input.addEventListener('focus',e=>{
      markRowFocus(input,true); setTimeout(()=>e.target.select(),0);
      const mu=ev=>{ev.preventDefault();input.removeEventListener('mouseup',mu);};
      input.addEventListener('mouseup',mu);
    });
    input.addEventListener('blur',()=>{markRowFocus(input,false);scheduleAutoCompute();});
    input.addEventListener('change',()=>scheduleAutoCompute());
    input.addEventListener('input',()=>{              /* ✱ CHG – always clear stored coords */
      input.dataset.lat='';input.dataset.lng='';
      scheduleAutoCompute();
    });

    /* Tab */
    input.addEventListener('keydown',e=>{
      if(e.key==='Tab'&&!e.shiftKey){
        if(input.dataset.lat&&input.dataset.lng)return;
        e.preventDefault();acceptTopPrediction(input);
      }
    });

    /* bulk paste */
    input.addEventListener('paste',e=>{
      const clip=(e.clipboardData||window.clipboardData).getData('text');
      const lines=clip.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      if(lines.length<=1)return; e.preventDefault();
      const rows=[...list.querySelectorAll('.row')];
      const start=rows.indexOf(input.closest('.row'));
      while(list.children.length<start+lines.length&&list.children.length<labels.length){
        const r=makeRow(list.children.length);list.appendChild(r);attach(r.querySelector('.stop'));
      }
      lines.forEach((addr,i)=>{
        if(start+i>=labels.length)return;
        const el=list.children[start+i].querySelector('.stop');
        el.value=addr;el.dataset.lat='';el.dataset.lng='';
      });
      renumber();autoCompute();
    });

    /* Google Places autocomplete */
    const ac=new google.maps.places.Autocomplete(input,acOpts);
    ac.addListener('place_changed',()=>{
      const plc=ac.getPlace();
      if(!plc.geometry){input.value='';return;}
      const loc=plc.geometry.location,pt={lat:loc.lat(),lng:loc.lng()};
      if(!insidePoly(pt,IHA_POLY)){
        input.value='';input.placeholder='Outside Interior Health';
        setTimeout(()=>{if(!input.value)input.placeholder=ph;},3000);return;
      }
      input.value=plc.formatted_address||plc.name;
      input.dataset.lat=pt.lat;input.dataset.lng=pt.lng;
      autoCompute();
    });
  };

  [...list.querySelectorAll('input.stop')].forEach(attach);

  /* buttons */
  document.getElementById('add').onclick=()=>{
    if(list.children.length<labels.length){
      const r=makeRow(list.children.length);list.appendChild(r);
      attach(r.querySelector('.stop'));renumber();
    }
  };
  document.getElementById('route').onclick=rebuildRoute;
  document.getElementById('opt').onclick=globalOptimizeRoute;
};
if(window.__mapsApiReady)window.routePlannerInit();

/* ── debounce ── */
const scheduleAutoCompute=(ms=250)=>{clearTimeout(autoTimer);autoTimer=setTimeout(autoCompute,ms);};

/* ── auto‑compute (batch geocode + preview pins) ── */
function autoCompute(){
  const rows=[...document.querySelectorAll('.row')];
  const filled=rows.filter(r=>r.querySelector('.stop').value.trim());
  const msg=document.getElementById('msg');

  if(filled.length===0){
    clearPreviewPins();clearLegDisplays();msg.textContent='';
    clearDirections();                                     /* ✱ NEW */
    return;
  }

  ensureCoords(filled).then(()=>{
    clearPreviewPins();
    filled.forEach((r,i)=>{
      const inp=r.querySelector('.stop');
      if(inp.dataset.lat&&inp.dataset.lng){
        addPreviewPin({lat:+inp.dataset.lat,lng:+inp.dataset.lng},labels[i]);
      }
    });
    if(filled.length===1){
      clearLegDisplays();clearDirections();                /* ✱ NEW */
      map.panTo({lat:+filled[0].querySelector('.stop').dataset.lat,
                 lng:+filled[0].querySelector('.stop').dataset.lng});
      msg.textContent='';
    }else{ rebuildRoute(); }
  });
}

/* ── routing helpers ── */
const rowToLocation=row=>{
  const inp=row.querySelector('.stop');
  return (inp.dataset.lat&&inp.dataset.lng)
    ? new google.maps.LatLng(+inp.dataset.lat,+inp.dataset.lng)
    : inp.value.trim();
};

function rebuildRoute(){
  const rows=[...document.querySelectorAll('.row')].filter(r=>r.querySelector('.stop').value.trim());
  const msg=document.getElementById('msg');
  clearLegDisplays();
  if(rows.length<2){msg.textContent='';clearDirections();return;}

  if(!dirRend.getMap()) dirRend.setMap(map);               /* ✱ NEW – re‑attach if needed */

  const locs=rows.map(rowToLocation);
  const reqId=++routeVersion;

  dirSvc.route({
    origin:locs[0],destination:locs[locs.length-1],
    waypoints:locs.slice(1,-1).map(l=>({location:l,stopover:true})),
    travelMode:'DRIVING'
  },(res,stat)=>{ if(reqId===routeVersion)displayLegs(res,stat); });
}

/* ── optimiser ── */
async function globalOptimizeRoute(){
  if(optimizerBusy) return;                                /* ✱ NEW */
  const btn=document.getElementById('opt');                /* ✱ NEW */
  optimizerBusy=true; btn.disabled=true;                   /* ✱ NEW */

  const msg=document.getElementById('msg');
  const list=document.getElementById('stops');
  const rows=[...list.querySelectorAll('.row')].filter(r=>r.querySelector('.stop').value.trim());

  /* Fallback: if only two stops, just rebuild the route */
  if(rows.length<3){
    rebuildRoute();
    optimizerBusy=false;btn.disabled=false;                /* ✱ NEW */
    return;
  }

  await ensureCoords(rows);
  const locs=rows.map(rowToLocation);
  routeVersion++; const runId=routeVersion;

  msg.textContent='Optimizing…';

  dirSvc.route({
    origin:locs[0],
    destination:locs[locs.length-1],
    waypoints:locs.slice(1,-1).map(l=>({location:l,stopover:true})),
    optimizeWaypoints:true,
    travelMode:'DRIVING'
  },(res,stat)=>{
    optimizerBusy=false;btn.disabled=false;                /* ✱ NEW */
    if(runId!==routeVersion)return;
    if(stat!=='OK'){msg.textContent='Optimize failed';return;}

    /* re‑order DOM to Google’s waypoint order */
    const order=[0,...res.routes[0].waypoint_order.map(i=>i+1),locs.length-1];
    const rowNodes=[...list.querySelectorAll('.row')];
    order.forEach(idx=>list.appendChild(rowNodes[idx]));
    renumber();

    if(!dirRend.getMap()) dirRend.setMap(map);             /* ✱ NEW */
    dirRend.setDirections(res);
    displayLegs(res,'OK');

    const km=res.routes[0].legs.reduce((s,l)=>s+l.distance.value,0)/1000;
    const mins=Math.round(res.routes[0].legs.reduce((s,l)=>s+l.duration.value,0)/60);
    msg.textContent=`Optimized distance ${km.toFixed(1)} km | ≈ ${mins} min`;
  });
}

/* leg display (unchanged) */
function displayLegs(res,stat){
  const msg=document.getElementById('msg');
  if(stat!=='OK'){msg.textContent='Route error: '+stat;clearDirections();return;}

  if(!dirRend.getMap()) dirRend.setMap(map);               /* ✱ NEW */
  dirRend.setDirections(res);
  const list=document.getElementById('stops');
  const rows=[...list.querySelectorAll('.row')];
  let kmTot=0,minTot=0;
  clearLegDisplays();

  res.routes[0].legs.forEach((leg,i)=>{
    const km=leg.distance.value/1000,min=Math.round(leg.duration.value/60);
    kmTot+=km;minTot+=min;
    const startLetter=rows[i]?.querySelector('.bullet')?.textContent.trim()||'';
    const cls=colourCycle.includes(startLetter)?('leg-'+startLetter):'leg-default';
    const div=document.createElement('div');
    div.className='leg-display '+cls;
    div.textContent=`Distance ${km.toFixed(1)} km | ≈ ${min} min`;
    rows[i].after(div);
  });
  msg.textContent=`Total Distance ${kmTot.toFixed(1)} km | ≈ ${minTot} min`;
}
</script>
</body>
</html>
