<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Okanagan Route Planner</title>

<link rel="stylesheet"
      href="https://fonts.googleapis.com/icon?family=Material+Icons">
<style>
html,body,#map{height:100%;margin:0;font-family:Roboto,Arial,sans-serif}
#panel{position:absolute;top:0;left:0;z-index:5;width:340px;max-height:100%;
       background:#fff;padding:16px 14px 12px;border-right:1px solid #ddd;
       box-shadow:0 0 6px rgba(0,0,0,.25);overflow:auto}
.row{display:flex;align-items:center;margin:10px 0}
.leg-display{margin:4px 0 0 28px;font-size:16px;color:#444}
.bullet{width:20px;height:20px;border-radius:50%;line-height:20px;text-align:center;
        font-weight:600;font-size:12px;color:#fff;margin-right:8px}
.A{background:#4285F4}.B{background:#0F9D58}.C{background:#F4B400}.D{background:#DB4437}
.defaultBullet{background:#607d8b}
input.stop{flex:1;height:38px;border:1px solid #ccc;border-radius:4px;padding:4px 6px;font-size:14px}
.drag{cursor:grab;margin-left:6px;color:#666}
.remove{cursor:pointer;margin-left:4px;font-size:20px;line-height:20px;color:#c00}
#add{margin:8px 0 14px 28px;padding:6px 10px}
#route,#opt{margin-left:8px;padding:8px 14px}
#msg{margin:10px 0;color:#0066cc;font-weight:500}
</style>

<!-- Google Maps & Places -->
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDnpSCHQWHr1neHALY-xddNne_S7f608co&callback=init&libraries=places,geometry">
</script>
<script type="module"
  src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/modular/sortable.core.esm.js">
</script>
</head>
<body>

<div id="panel">
  <div id="stops"></div>
  <button id="add">+ Add stop</button>
  <button id="route">Route</button>
  <button id="opt">Optimize</button>
  <div id="msg"></div>
  <small>Hold <b>Ctrl</b> and click the map to add way‑points interactively.</small>
</div>
<div id="map"></div>

<script type="module">
import Sortable from 'https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/+esm';

const labels='ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
let map, dirSvc, dirRend;

/* ★ NEW globals for auto‑compute & preview marker */
let geocoder;                 // google.maps.Geocoder
let previewMarker=null;       // single marker when only 1 stop
let autoTimer=null;           // debounce timer

/* ── Interior‑Health polygon ── */
const IHA_POLY=[
 {lat:53.40,lng:-118.50},{lat:53.50,lng:-122.00},{lat:52.50,lng:-123.00},
 {lat:51.00,lng:-123.00},{lat:50.10,lng:-123.20},{lat:49.80,lng:-122.40},
 {lat:49.00,lng:-120.00},{lat:49.00,lng:-114.00},{lat:51.20,lng:-114.00},
 {lat:53.00,lng:-116.00}
];
function insidePoly(pt,poly){
  let c=false,j=poly.length-1;
  for(let i=0;i<poly.length;i++){
    const pi=poly[i],pj=poly[j];
    if(((pi.lng>pt.lng)!=(pj.lng>pt.lng)) &&
        pt.lat<(pj.lat-pi.lat)*(pt.lng-pi.lng)/(pj.lng-pi.lng)+pi.lat) c=!c;
    j=i;
  }
  return c;
}

/* ── helpers ── */
function makeRow(i){
  const d=document.createElement('div'); d.className='row';
  d.innerHTML=`<div class="bullet ${labels[i]}">${labels[i]}</div>
    <input class="stop" placeholder="Enter stop">
    <span class="material-icons drag" title="Drag to reorder">drag_indicator</span>
    <span class="remove" title="Remove stop">×</span>`;
  /* ★ CHG: call autoCompute() instead of rebuildRoute() on remove */
  d.querySelector('.remove').onclick=()=>{d.remove();renumber();autoCompute();};
  return d;
}
const addresses=()=>[...document.querySelectorAll('input.stop')]
                   .map(e=>e.value.trim()).filter(Boolean);
function renumber(){
  [...document.querySelectorAll('.row')].forEach((r,i)=>{
    const b=r.querySelector('.bullet');
    b.textContent=labels[i]||'?';
    b.className='bullet '+(i<4?labels[i]:'defaultBullet');
  });
}

/* ★ NEW: clear the single preview marker */
function clearPreviewMarker(){
  if(previewMarker){previewMarker.setMap(null);previewMarker=null;}
}

/* ★ NEW: drop (or move) the preview marker */
function showPreviewMarker(pos,label=''){
  clearPreviewMarker();
  previewMarker=new google.maps.Marker({
    map,position:pos,
    label:label?{text:label,color:'#fff',fontWeight:'bold'}:undefined
  });
  map.panTo(pos);
  if(map.getZoom()<14) map.setZoom(14);
}

/* ★ NEW: geocode free‑typed address & show marker (1 stop case) */
function geocodeAndPreview(addr,label=''){
  geocoder.geocode({address:addr,componentRestrictions:{country:'ca'}},(res,stat)=>{
    if(stat!=='OK'||!res[0]) return;
    const g=res[0].geometry.location;
    const pt={lat:g.lat(),lng:g.lng()};
    if(!insidePoly(pt,IHA_POLY)) return; // silently ignore out‑of‑area
    showPreviewMarker(g,label);
  });
}

/* ── prediction filter ── */
function installPredictionFilter(){
  const forbid=/vancouver\b|victoria\b|island|nanaimo|campbell river|saanich/i;
  const notBC=/,\s?(AB|SK|MB|ON|QC|NB|NS|NL|PE|YT|NT|NU)\b/i;
  new MutationObserver(muts=>{
    muts.forEach(m=>m.addedNodes.forEach(node=>{
      if(node.nodeType===1 && node.classList.contains('pac-item')){
        const txt=node.textContent;
        if(notBC.test(txt) || forbid.test(txt)) node.style.display='none';
      }
    }));
  }).observe(document.body,{childList:true,subtree:true});
}

/* ── init ── */
window.init=()=>{
  installPredictionFilter();

  map=new google.maps.Map(document.getElementById('map'),{
    center:{lat:49.9,lng:-119.5},zoom:9
  });
  new google.maps.KmlLayer({
    url:'https://circuitsagexy.github.io/okanagan-map/r5a1LjX92e-djkvc12df/okanagan.kmz',
    map,preserveViewport:true
  });

  dirSvc=new google.maps.DirectionsService();
  dirRend=new google.maps.DirectionsRenderer({map});
  geocoder=new google.maps.Geocoder();              /* ★ NEW */

  const list=document.getElementById('stops');
  list.appendChild(makeRow(0)); list.appendChild(makeRow(1));

  Sortable.create(list,{handle:'.drag',animation:150,
    onEnd:()=>{renumber();autoCompute();}  /* ★ CHG */
  });

  const bcInterior={south:49.2,north:53.5,west:-124.0,east:-114.0};
  const acOpts={fields:['formatted_address','geometry'],
                componentRestrictions:{country:'ca'},
                bounds:bcInterior,strictBounds:true};

  const attach=input=>{
    const normalPH='Enter stop';
    input.placeholder=normalPH;

    /* select‑all on first focus */
    input.addEventListener('focus',e=>{
      input.placeholder=normalPH;
      setTimeout(()=>e.target.select(),0);
      const mu=ev=>{ev.preventDefault();input.removeEventListener('mouseup',mu);};
      input.addEventListener('mouseup',mu);
    });

    /* react to manual edits (blur/change) */
    input.addEventListener('change',()=>scheduleAutoCompute());   /* ★ NEW */
    input.addEventListener('blur',()=>scheduleAutoCompute());     /* ★ NEW */

    /* ── NEW : smart‑paste multiple addresses ── */
    input.addEventListener('paste',e=>{
      const clip=(e.clipboardData||window.clipboardData).getData('text');
      const lines=clip.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      if(lines.length<=1) return;               // single‑line paste behaves normally
      e.preventDefault();

      const list=document.getElementById('stops');
      const rows=[...list.querySelectorAll('.row')];
      const start=rows.indexOf(input.closest('.row'));

      // add rows until we can fit everything (or hit Z)
      while(list.children.length<start+lines.length && list.children.length<labels.length){
        const r=makeRow(list.children.length);
        list.appendChild(r);
        attach(r.querySelector('.stop'));
      }

      lines.forEach((addr,i)=>{
        if(start+i>=labels.length) return;      // out of letters
        const el=list.children[start+i].querySelector('.stop');
        el.value=addr;
        el.dataset.lat='';el.dataset.lng='';    /* ★ NEW reset */
      });

      renumber();
      autoCompute();                            /* ★ CHG */
    });

    /* autocomplete */
    const ac=new google.maps.places.Autocomplete(input,acOpts);
    ac.addListener('place_changed',()=>{
      const plc=ac.getPlace();
      if(!plc.geometry){input.value='';return;}
      const {lat,lng}=plc.geometry.location;
      const pt={lat:lat(),lng:lng()};
      if(!insidePoly(pt,IHA_POLY)){
        input.value='';input.placeholder='Outside Interior Health';
        setTimeout(()=>{if(!input.value)input.placeholder=normalPH;},3000);
        return;
      }
      /* ★ NEW: normalize to full address & store coords */
      if(plc.formatted_address) input.value=plc.formatted_address;
      input.dataset.lat=pt.lat;
      input.dataset.lng=pt.lng;

      /* ★ NEW: immediate preview if only this stop currently filled */
      const pts=addresses();
      const rows=[...document.querySelectorAll('.row')];
      const idx=rows.indexOf(input.closest('.row'));
      if(pts.length===1){
        showPreviewMarker(plc.geometry.location,labels[idx]||'');
      }

      autoCompute();  /* ★ NEW: trigger auto route/preview */
    });
  };
  [...list.querySelectorAll('input.stop')].forEach(attach);

  document.getElementById('add').onclick=()=>{
    if(list.children.length<labels.length){
      const r=makeRow(list.children.length);list.appendChild(r);
      attach(r.querySelector('.stop'));renumber();
    }
  };
  document.getElementById('route').onclick=rebuildRoute;  // still available
  document.getElementById('opt').onclick  =optimizeRoute;
};

/* ★ NEW: debounce helper */
function scheduleAutoCompute(ms=250){
  clearTimeout(autoTimer);
  autoTimer=setTimeout(autoCompute,ms);
}

/* ★ NEW: decide whether to show preview pin or full route */
function autoCompute(){
  const pts=addresses();
  const msg=document.getElementById('msg');

  if(pts.length===0){
    clearPreviewMarker();
    msg.textContent='';
    dirRend.setDirections({});
    return;
  }

  if(pts.length===1){
    // show single pin
    dirRend.setDirections({});  // clear any prior route
    msg.textContent='';
    // find the row holding the address so we can use stored coords if we have them
    const rows=[...document.querySelectorAll('.row')];
    const row=rows.find(r=>r.querySelector('.stop').value.trim());
    if(row){
      const inp=row.querySelector('.stop');
      const lat=+inp.dataset.lat, lng=+inp.dataset.lng;
      if(!isNaN(lat)&&!isNaN(lng)){
        showPreviewMarker({lat,lng},labels[rows.indexOf(row)]||'');
      }else{
        geocodeAndPreview(inp.value.trim(),labels[rows.indexOf(row)]||'');
      }
    }
    return;
  }

  // 2+ stops -> clear preview & build full route (auto)
  clearPreviewMarker();
  rebuildRoute();
}

/* ── routing logic (unchanged except small guard) ── */
function rebuildRoute(){
  const pts=addresses(),msg=document.getElementById('msg');
  document.querySelectorAll('.leg-display').forEach(e=>e.remove());
  if(pts.length<2){msg.textContent='';dirRend.setDirections({});return;}
  dirSvc.route({
    origin:pts[0],destination:pts[pts.length-1],
    waypoints:pts.slice(1,-1).map(l=>({location:l,stopover:true})),
    travelMode:'DRIVING',optimizeWaypoints:false
  },(res,stat)=>displayLegs(res,stat));
}
function optimizeRoute(){
  const pts=addresses();if(pts.length<3){rebuildRoute();return;}
  dirSvc.route({
    origin:pts[0],destination:pts[0],
    waypoints:pts.slice(1).map(l=>({location:l,stopover:true})),
    travelMode:'DRIVING',optimizeWaypoints:true
  },(res,stat)=>{
    if(stat!=='OK'){alert('Optimize failed: '+stat);return;}
    const order=res.routes[0].waypoint_order;
    const loop=[0,...order.map(i=>i+1)];
    const legs=res.routes[0].legs;
    const longest=legs.reduce((mx,l,i)=>l.distance.value>mx.v?{i,v:l.distance.value}:mx,{i:-1,v:0}).i;
    const list=document.getElementById('stops');
    const rows=[...list.querySelectorAll('.row')];
    const rot=[];for(let n=1;n<loop.length;n++)rot.push(loop[(longest+1+n)%loop.length]);
    rot.forEach(i=>list.appendChild(rows[i]));
    list.prepend(rows[loop[(longest+1)%loop.length]]);
    renumber();
    autoCompute(); /* ★ CHG */
  });
}
function displayLegs(res,stat){
  const msg=document.getElementById('msg');
  if(stat!=='OK'){msg.textContent='Route error: '+stat;dirRend.setDirections({});return;}
  dirRend.setDirections(res);
  const list=document.getElementById('stops');
  const rows=[...list.querySelectorAll('.row')];
  let kmTot=0,minTot=0;
  document.querySelectorAll('.leg-display').forEach(e=>e.remove());
  res.routes[0].legs.forEach((leg,i)=>{
    const km=leg.distance.value/1000,min=Math.round(leg.duration.value/60);
    kmTot+=km;minTot+=min;
    const div=document.createElement('div');
    div.className='leg-display';
    div.textContent=`Distance ${km.toFixed(1)} km | ≈ ${min} min`;
    rows[i].after(div);
  });
  msg.textContent=`Total Distance ${kmTot.toFixed(1)} km | ≈ ${minTot} min`;
}
</script>
</body>
</html>
