<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Okanagan Route Planner</title>

<link rel="stylesheet"
      href="https://fonts.googleapis.com/icon?family=Material+Icons">
<style>
/* ── existing CSS ──────────────────────────────────────────────── */
html,body,#map{height:100%;margin:0;font-family:Roboto,Arial,sans-serif}
#panel{position:absolute;top:0;left:0;z-index:5;width:340px;max-height:100%;
       background:#fff;padding:16px 14px 12px;border-right:1px solid #ddd;
       box-shadow:0 0 6px rgba(0,0,0,.25);overflow:auto}
.row{display:flex;align-items:center;margin:10px 0}
.leg-display{margin:4px 0 0 28px;font-size:16px;color:#444}
.bullet{width:20px;height:20px;border-radius:50%;line-height:20px;text-align:center;
        font-weight:600;font-size:12px;color:#fff;margin-right:8px}
.A{background:#4285F4}.B{background:#0F9D58}.C{background:#F4B400}.D{background:#DB4437}
.defaultBullet{background:#607d8b}
input.stop{flex:1;height:38px;border:1px solid #ccc;border-radius:4px;padding:4px 6px;font-size:14px}
.drag{cursor:grab;margin-left:6px;color:#666}
#add{margin:8px 0 14px 28px;padding:6px 10px}
#route,#opt{margin-left:8px;padding:8px 14px}
#msg{margin:10px 0;color:#0066cc;font-weight:500}
</style>

<!-- Google Maps JS -->
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDnpSCHQWHr1neHALY-xddNne_S7f608co&callback=init&libraries=places,geometry">
</script>
<!-- SortableJS -->
<script type="module"
  src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/modular/sortable.core.esm.js">
</script>
</head>
<body>

<div id="panel">
  <div id="stops"></div>
  <button id="add">+ Add stop</button>
  <button id="route">Route</button>
  <button id="opt">Optimize</button>
  <div id="msg"></div>
  <small>Hold <b>Ctrl</b> and click the map to add way-points interactively.</small>
</div>
<div id="map"></div>

<script type="module">
import Sortable from 'https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/+esm';

const labels = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
let map, dirSvc, dirRend;

/* ── Interior-Health polygon ── */
const IHA_POLY = [
  {lat:53.40,lng:-118.50},{lat:53.50,lng:-122.00},{lat:52.50,lng:-123.00},
  {lat:51.00,lng:-123.00},{lat:50.10,lng:-123.20},{lat:49.80,lng:-122.40},
  {lat:49.00,lng:-120.00},{lat:49.00,lng:-114.00},{lat:51.20,lng:-114.00},
  {lat:53.00,lng:-116.00}
];
function insidePoly(pt, poly) {
  let c=false, j=poly.length-1;
  for (let i=0;i<poly.length;i++) {
    const pi=poly[i], pj=poly[j];
    if (((pi.lng>pt.lng)!=(pj.lng>pt.lng)) &&
        pt.lat < (pj.lat-pi.lat)*(pt.lng-pi.lng)/(pj.lng-pi.lng)+pi.lat)
        c = !c;
    j = i;
  }
  return c;
}

/* ── helpers ── */
function makeRow(i) {
  const d = document.createElement('div'); d.className = 'row';
  d.innerHTML = `
    <div class="bullet ${labels[i]}">${labels[i]}</div>
    <input class="stop" placeholder="Enter stop">
    <span class="material-icons drag">drag_indicator</span>`;
  return d;
}
const addresses = () => [...document.querySelectorAll('input.stop')]
                     .map(e=>e.value.trim()).filter(Boolean);
function renumber() {
  [...document.querySelectorAll('.row')].forEach((r,i)=>{
    const b=r.querySelector('.bullet');
    b.textContent = labels[i] || '?';
    b.className   = 'bullet ' + (i<4?labels[i]:'defaultBullet');
  });
}

/* ── hide “forbidden” predictions ── */
function installPredictionFilter() {
  const forbid = /vancouver\b|victoria\b|island|nanaimo|campbell river|saanich/i;
  new MutationObserver(muts=>{
    muts.forEach(m=>m.addedNodes.forEach(node=>{
      if (node.nodeType===1 && node.classList.contains('pac-item') &&
          forbid.test(node.textContent))
        node.style.display='none';
    }));
  }).observe(document.body,{childList:true,subtree:true});
}

/* ── init ── */
window.init = () => {
  installPredictionFilter();

  map = new google.maps.Map(document.getElementById('map'), {
    center:{lat:49.9,lng:-119.5}, zoom:9
  });

  /* ►►  KMZ overlay  ◄◄ */
  new google.maps.KmlLayer({
    url: 'https://circuitsagexy.github.io/okanagan-map/r5a1LjX92e-djkvc12df/okanagan.kmz',
    map,
    preserveViewport:true
  });

  dirSvc  = new google.maps.DirectionsService();
  dirRend = new google.maps.DirectionsRenderer({map});

  const list = document.getElementById('stops');
  list.appendChild(makeRow(0)); list.appendChild(makeRow(1));

  Sortable.create(list,{handle:'.drag',animation:150,
    onEnd:()=>{renumber(); rebuildRoute();}});

  const bcInterior = {south:49.2,north:53.5,west:-124.0,east:-113.5};
  const acOpts = {fields:['formatted_address','geometry'],
                  componentRestrictions:{country:'ca'},
                  bounds:bcInterior, strictBounds:true};

  /* attach Google Places AC to every input */
  const attach = input=>{
    const ac = new google.maps.places.Autocomplete(input,acOpts);
    ac.addListener('place_changed', ()=>{
      const plc = ac.getPlace();
      if(!plc.geometry){input.value='';return;}
      const {lat,lng}=plc.geometry.location;
      if(!insidePoly({lat:lat(),lng:lng()},IHA_POLY)){
        input.value=''; input.placeholder='Outside Interior Health';
      }
    });
  };
  [...list.querySelectorAll('input.stop')].forEach(attach);

  document.getElementById('add').onclick=()=>{
    if(list.children.length<labels.length){
      const r=makeRow(list.children.length); list.appendChild(r);
      attach(r.querySelector('input.stop')); renumber();
    }
  };
  document.getElementById('route').onclick=rebuildRoute;
  document.getElementById('opt').onclick  =optimizeRoute;
};

/* ── routing (your existing code) ── */
function rebuildRoute(){ /* … unchanged … */ }
function optimizeRoute(){/* … unchanged … */ }
function displayLegs(res,stat){/* … unchanged … */ }
</script>
</body>
</html>
