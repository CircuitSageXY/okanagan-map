<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Okanagan Route Planner</title>

<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap">

<style>
/* ---------- GLOBAL VARIABLES ---------- */
:root{
  --clrA:#4285F4; --clrB:#0F9D58; --clrC:#F4B400; --clrD:#DB4437;
  --clrE:#ab47bc; --clrF:#00acc1; --clrG:#ff7043; --clrH:#8d6e63;
  --clrDefault:#607d8b;

  --clrPanelBg:#ffffff; --clrPanelBorder:#d7d7d7; --clrPanelStripe:#2196f3;
  --clrPanelShadow:0 2px 8px rgba(0,0,0,.25);
  --clrInputBorder:#c7c7c7; --clrInputBg:#fff; --clrInputBgAlt:#fafafa;

  --radiusSm:4px; --radiusMd:6px; --radiusLg:10px;
  --transFast:.12s; --fontMain:Roboto,Arial,sans-serif;

  --f-early:#8BC34A; --f-late:#4CAF50; --f-lunch:#FFEB3B;
  --f-afternoon:#03A9F4; --f-supper:#FF9800;
  --f-evening:#BA68C8; --f-lateev:#F44336;

  --gutterW:56px;           /* timeline gutter inside each frame */
  --tickMinor:#9e9e9e;      /* tick marks */
  --tickMajor:#424242;
}

/* ---------- BASICS ---------- */
html,body,#map{height:100%;margin:0;font-family:var(--fontMain);}
#map{backface-visibility:hidden;transform:translateZ(0);}
.hidden{display:none!important;}

/* ---------- SIDE PANEL ---------- */
#panel{
  position:absolute;top:0;left:0;z-index:5;width:520px;height:100%;
  background:var(--clrPanelBg);border-right:1px solid var(--clrPanelBorder);
  box-shadow:var(--clrPanelShadow);border-top-right-radius:var(--radiusLg);
  border-bottom-right-radius:var(--radiusLg);display:flex;flex-direction:column;
}
#scroller{flex:1;overflow:auto;position:relative;padding:12px 12px 96px 12px;}
#content{display:block;position:relative;}
#framesContainer{display:flex;flex-direction:column;gap:14px;}

/* ---------- FRAME (with fused timeline gutter) ---------- */
.frame{
  border:1px solid var(--clrPanelBorder);border-radius:8px;background:#fff;
  box-shadow:0 1px 2px rgba(0,0,0,.08);
  display:grid;grid-template-columns:var(--gutterW) 1fr;align-items:stretch;
  overflow:hidden;
}
.frame[data-frame="0"]{border-left:4px solid var(--f-early);}
.frame[data-frame="1"]{border-left:4px solid var(--f-late);}
.frame[data-frame="2"]{border-left:4px solid var(--f-lunch);}
.frame[data-frame="3"]{border-left:4px solid var(--f-afternoon);}
.frame[data-frame="4"]{border-left:4px solid var(--f-afternoon);}
.frame[data-frame="5"]{border-left:4px solid var(--f-supper);}
.frame[data-frame="6"]{border-left:4px solid var(--f-evening);}
.frame[data-frame="7"]{border-left:4px solid var(--f-lateev);}

/* fused gutter */
.frame-gutter{
  position:relative; background:linear-gradient(to right, rgba(0,0,0,.04), transparent);
}
.g-axis{position:absolute;left:12px;top:0;bottom:0;width:4px;background:#000;border-radius:2px;}
.g-tick{position:absolute;left:12px;width:100%;}
.g-tick::before{
  content:"";position:absolute;left:4px;top:0;width:8px;height:1px;background:var(--tickMinor);
}
.g-tick.major::before{width:12px;background:var(--tickMajor);}
.g-label{
  position:absolute;left:22px;top:-7px;font-size:11px;color:#424242;background:rgba(255,255,255,.85);
  padding:0 2px;border-radius:2px;line-height:1;
}

/* frame body */
.frame-body{display:flex;flex-direction:column;min-width:0;}
.frame-header{
  position:sticky;top:0;z-index:2;display:flex;align-items:center;gap:8px;padding:8px 10px;
  font-size:15px;font-weight:500;color:#000;border-bottom:1px solid #e0e0e0;background:#fafafa;
}
.frame-header .swatch{width:16px;height:16px;border-radius:3px;flex:none;}
.frame-interval{margin-left:8px;font-weight:400;color:#666;font-size:12px;}
.frame-tools{margin-left:auto;display:flex;gap:8px;align-items:center;}
.icon-btn{cursor:pointer;color:#666;font-size:20px;line-height:20px;}
.icon-btn:hover{color:#000;}

.frame-content{position:relative;display:flex;flex-direction:column;gap:8px;padding:8px 10px 10px 8px;}
.frame-list{overflow:visible;} /* grow to fit; scrolling left to the scroller */

.addRowBtn{
  margin-left:28px;background:#e0e0e0;color:#000;border:1px solid #d0d0d0;
  padding:4px 10px;border-radius:4px;font-size:13px;cursor:pointer;align-self:flex-start;}
.addRowBtn:hover{background:#e7e7e7;}

/* collapsed state hides both content & gutter (fused behavior) */
.frame.collapsed .frame-content{display:none;}
.frame.collapsed .frame-gutter{display:none;}
.frame.collapsed{opacity:.7}

/* ---------- ROWS ---------- */
.row{display:flex;align-items:center;gap:8px;margin:6px 0;padding:4px 6px 4px 0;border-radius:6px;transition:background var(--transFast),box-shadow var(--transFast),outline var(--transFast);}
.row.focused{background:var(--clrInputBgAlt);box-shadow:0 0 0 2px rgba(33,150,243,.25);}
.row:hover:not(.focused):not(.selected){background:rgba(0,0,0,.04);}
.row.invalid input.stop{border-color:#e53935;background:#fff7f7;}
.row.selected{outline:3px solid rgba(33,150,243,.6);}

.bullet{
  min-width:24px;min-height:24px;padding:0 6px;border-radius:50%;
  line-height:24px;text-align:center;font-weight:700;font-size:13px;color:#fff;flex:none;
  box-shadow:0 0 0 2px rgba(255,255,255,.85),0 0 4px rgba(0,0,0,.35);
}
.defaultBullet{background:var(--clrDefault);}
.A{background:var(--clrA)} .B{background:var(--clrB)}
.C{background:var(--clrC)} .D{background:var(--clrD)}
.E{background:var(--clrE)} .F{background:var(--clrF)}
.G{background:var(--clrG)} .H{background:var(--clrH)}

input.stop{
  flex:1;height:38px;border:1px solid var(--clrInputBorder);
  border-radius:4px;padding:4px 6px 4px 10px;font-size:14px;background:#fff;
  transition:border-color var(--transFast),box-shadow var(--transFast);}
input.stop:focus{outline:none;border-color:var(--clrPanelStripe);box-shadow:0 0 0 3px rgba(33,150,243,.25);}

.row[data-frame="0"] input.stop{border-left:4px solid var(--f-early);    padding-left:6px;}
.row[data-frame="1"] input.stop{border-left:4px solid var(--f-late);     padding-left:6px;}
.row[data-frame="2"] input.stop{border-left:4px solid var(--f-lunch);    padding-left:6px;}
.row[data-frame="3"] input.stop{border-left:4px solid var(--f-afternoon);padding-left:6px;}
.row[data-frame="4"] input.stop{border-left:4px solid var(--f-afternoon);padding-left:6px;}
.row[data-frame="5"] input.stop{border-left:4px solid var(--f-supper);   padding-left:6px;}
.row[data-frame="6"] input.stop{border-left:4px solid var(--f-evening);  padding-left:6px;}
.row[data-frame="7"] input.stop{border-left:4px solid var(--f-lateev);   padding-left:6px;}

.drag{cursor:grab;color:#666;font-size:22px;line-height:22px;padding:2px;border-radius:4px;}
.drag:hover{background:rgba(0,0,0,.08);} .drag:active{cursor:grabbing;}
.remove{
  cursor:pointer;font-size:20px;line-height:20px;color:#fff;width:22px;height:22px;
  display:inline-flex;align-items:center;justify-content:center;background:var(--clrD);border-radius:4px;
  transition:transform var(--transFast),background var(--transFast);}
.remove:hover{background:#f75a4d;transform:scale(1.08);} .remove:active{transform:scale(.94);}

/* ---------- ACTION BUTTONS / MESSAGES ---------- */
#actions{position:absolute;bottom:12px;left:16px;right:16px;display:flex;gap:10px;flex-wrap:wrap;z-index:7;}
#actions button{padding:8px 14px;font-size:14px;border-radius:6px;border:1px solid transparent;cursor:pointer;transition:background var(--transFast),transform var(--transFast);}
#route{background:var(--clrA);color:#fff;border-color:var(--clrA);}        #route:hover{background:#5b9bff;} #route:active{transform:scale(.96);}
#optAll{background:var(--clrB);color:#fff;border-color:var(--clrB);}       #optAll:hover{background:#26c36c;} #optAll:active{transform:scale(.96);}
#optFrames{background:#795548;color:#fff;border-color:#795548;}            #optFrames:hover{background:#8d6e63;} #optFrames:active{transform:scale(.96);}

#msg{margin:12px 0 0 2px;color:#0066cc;font-weight:700;font-size:17px;}

/* ---------- STREET VIEW BACK ---------- */
#svBack{
  position:fixed;bottom:16px;right:16px;z-index:1200;
  padding:8px 14px;border:none;border-radius:6px;background:#455a64;color:#fff;
  font-size:14px;cursor:pointer;display:none;box-shadow:0 2px 6px rgba(0,0,0,.35);}
#svBack:hover{background:#546e7a;}

/* ---------- FLAT MODE (kept for completeness) ---------- */
#panel.flat{width:auto;background:transparent;border:none;box-shadow:none;pointer-events:none;}
#panel.flat #content{display:none;}
#panel.flat #scroller{padding:12px;}
#panel.flat #msg,#panel.flat #actions{display:none;}

#addrBar{
  position:absolute;top:12px;left:12px;width:380px;z-index:8;background:rgba(255,255,255,.75);
  border:1px solid #d7d7d7;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.25);
  padding:12px 12px 10px 12px;pointer-events:auto;display:none;backdrop-filter:blur(2px);}
#addrBar.active{display:block;}
#addrBarHeader{display:flex;align-items:center;gap:8px;margin-bottom:6px;font-weight:500;font-size:15px;}
#addrTitle{flex:1;}
#addrToggles{display:flex;gap:6px;}
.toggleChip{padding:3px 10px;border-radius:14px;border:1px solid #bbb;font-size:12px;cursor:pointer;user-select:none;line-height:16px;display:inline-block;min-width:46px;text-align:center;}
.toggleChip.day  {border-color:var(--f-afternoon);color:var(--f-afternoon);}
.toggleChip.night{border-color:var(--f-evening);color:var(--f-evening);}
.toggleChip.active.day  {background:var(--f-afternoon);color:#fff;}
.toggleChip.active.night{background:var(--f-evening);color:#fff;}
#addrAdd{background:#fff;border:1px solid #bbb;border-radius:50%;width:24px;height:24px;font-size:16px;line-height:22px;text-align:center;cursor:pointer;flex:none;}
#addrAdd:hover{background:#f2f2f2;}
#addrList .row{margin:6px 0;}
#addrFooter{margin-top:10px;border-top:1px solid #dadada;padding-top:8px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
#flatMsg{font-size:16px;font-weight:700;color:#0066cc;flex:1 1 100%;}
#flatButtons{display:flex;gap:8px;}
#flatButtons button{padding:6px 12px;font-size:13px;border-radius:6px;cursor:pointer;border:none;}
#flatRoute{background:var(--clrA);color:#fff;}
#flatOpt{background:var(--clrB);color:#fff;}
#flatDelSel{background:#db4437;color:#fff;display:none;}
</style>

<script>
function init(){ if(window.routePlannerInit) window.routePlannerInit(); else window.__mapsApiReady=true; }
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDnpSCHQWHr1neHALY-xddNne_S7f608co&callback=init&libraries=places,geometry"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>

<body>
<button id="svBack">Back to Map</button>

<div id="panel">
  <div id="scroller">
    <div id="content">
      <div id="framesContainer"></div>
    </div>
    <div id="msg"></div>
  </div>
  <div id="actions">
    <button id="route">Route</button>
    <button id="optAll"    title="Optimize entire day">Optimize</button>
    <button id="optFrames" title="Optimize each time frame separately">Optimize by Frames</button>
  </div>
</div>

<!-- ---------- FLAT (directions list) ---------- -->
<div id="addrBar">
  <div id="addrBarHeader">
    <span id="addrTitle">Directions</span>
    <div id="addrToggles">
      <span id="toggleDay"   class="toggleChip day">Day</span>
      <span id="toggleNight" class="toggleChip night">Night</span>
    </div>
    <button id="addrAdd" title="Add stop">+</button>
  </div>
  <div id="addrList"></div>

  <div id="addrFooter">
    <div id="flatMsg"></div>
    <div id="flatButtons">
      <button id="flatRoute">Route</button>
      <button id="flatOpt">Optimize</button>
      <button id="flatDelSel">Delete Selected</button>
    </div>
  </div>
</div>

<div id="map"></div>

<script>
/* =================== CONFIG / CONSTANTS =================== */
const colourCycle = ['A','B','C','D','E','F','G','H'];
const DEFAULT_ROWS_PER_FRAME = 4;

let map,dirSvc,dirRend,geocoder,acService,placeSvc;
let previewPins=[],routeMarkers=[];
let autoTimer=null, autoResolveNext=false;
let dayVisible=false, nightVisible=false, flatMode=false;
let OK_BOUNDS;

/* ---------- FRAMES ---------- */
const FRAMES=[
  {id:0,key:'early',     name:'AM Early',     start:'07:00', end:'09:00',  color:'var(--f-early)',     shift:'day'},
  {id:1,key:'late',      name:'AM Late',      start:'09:00', end:'11:00',  color:'var(--f-late)',      shift:'day'},
  {id:2,key:'lunch',     name:'Lunch',        start:'11:00', end:'13:00',  color:'var(--f-lunch)',     shift:'day'},
  {id:3,key:'afternoon', name:'Afternoon',    start:'13:00', end:'15:30',  color:'var(--f-afternoon)', shift:'day'},
  {id:4,key:'aftNight',  name:'Afternoon',    start:'13:30', end:'16:00',  color:'var(--f-afternoon)', shift:'night'},
  {id:5,key:'supper',    name:'Supper',       start:'16:00', end:'18:30',  color:'var(--f-supper)',    shift:'night'},
  {id:6,key:'evening',   name:'Evening',      start:'18:30', end:'21:00',  color:'var(--f-evening)',   shift:'night'},
  {id:7,key:'lateev',    name:'Late Evening', start:'21:00', end:'22:30',  color:'var(--f-lateev)',    shift:'night'}
];

/* ---------- TIME HELPERS ---------- */
const mins=(h,m)=>h*60+m;
const parseHM=t=>{const [h,m]=t.split(':').map(Number);return mins(h,m);};
const pad=n=>n.toString().padStart(2,'0');

/* =================== UI BUILD =================== */
function buildFrameBuckets(){
  const container=document.getElementById('framesContainer');
  container.innerHTML='';

  FRAMES.forEach(fr=>{
    // shell
    const sec=document.createElement('section');
    sec.className='frame'; sec.dataset.frame=fr.id; sec.dataset.shift=fr.shift;

    // gutter (fused timeline)
    const gut=document.createElement('div');
    gut.className='frame-gutter';
    gut.innerHTML='<div class="g-axis"></div><div class="g-ticks"></div>';
    sec.appendChild(gut);

    // body
    const body=document.createElement('div'); body.className='frame-body';

    const head=document.createElement('div');
    head.className='frame-header';
    head.innerHTML=`<span class="swatch" style="background:${fr.color}"></span>${fr.name}
                    <span class="frame-interval">(${fr.start}–${fr.end})</span>`;
    const tools=document.createElement('div'); tools.className='frame-tools';
    const btnVis=document.createElement('span'); btnVis.className='material-icons icon-btn'; btnVis.textContent='visibility';
    btnVis.title='Hide / show this time frame';
    btnVis.onclick=()=>toggleFrame(fr.id, btnVis);
    tools.appendChild(btnVis);
    head.appendChild(tools);
    body.appendChild(head);

    const content=document.createElement('div'); content.className='frame-content';

    const list=document.createElement('div');
    list.className='frame-list'; list.id='frame-'+fr.id;
    content.appendChild(list);

    const addBtn=document.createElement('button');
    addBtn.className='addRowBtn'; addBtn.textContent='+ Add stop';
    addBtn.onclick=()=>addRowToFrame(fr.id,true,false);
    content.appendChild(addBtn);

    body.appendChild(content);
    sec.appendChild(body);
    container.appendChild(sec);

    // sort within this list
    Sortable.create(list,{
      group:'stops', handle:'.drag', animation:150,
      onEnd:evt=>{
        evt.item.dataset.frame=list.closest('.frame').dataset.frame;
        renumber(); scheduleAutoCompute(120,false); buildLocalTimeline(fr.id);
      }
    });

    // top up defaults if empty
    ensureFourIfNoFilled(fr.id);

    // observe for dynamic gutter ticks
    const ro=new ResizeObserver(()=>buildLocalTimeline(fr.id));
    ro.observe(content);
    const mo=new MutationObserver(()=>buildLocalTimeline(fr.id));
    mo.observe(list,{childList:true,subtree:true});
  });

  // both shifts start visible so user sees defaults; you can toggle with F1/F2
  dayVisible=true; nightVisible=true; applyShiftVisibility();
  renumber();

  // initial gutters
  FRAMES.forEach(fr=>buildLocalTimeline(fr.id));
}

function buildLocalTimeline(frameId){
  const fr=FRAMES.find(f=>f.id===frameId);
  const sec=document.querySelector(`.frame[data-frame="${frameId}"]`);
  if(!sec || sec.classList.contains('collapsed') || sec.style.display==='none') return;

  const ticksHost=sec.querySelector('.g-ticks'); ticksHost.innerHTML='';
  const content=sec.querySelector('.frame-content');
  if(!content) return;

  const totalMin=parseHM(fr.end)-parseHM(fr.start);
  const h=content.offsetHeight; if(h<=0) return;
  const pxPerMin=h/totalMin;

  // ticks each 30m (hour marks bold)
  for(let t=parseHM(fr.start); t<=parseHM(fr.end); t+=30){
    const y=(t - parseHM(fr.start))*pxPerMin;
    const div=document.createElement('div');
    div.className='g-tick'+(t%60===0?' major':''); div.style.top=`${y}px`;
    const label=document.createElement('div');
    label.className='g-label';
    label.textContent=`${pad(Math.floor(t/60))}:${pad(t%60)}`;
    div.appendChild(label);
    ticksHost.appendChild(div);
  }
}

/* rows */
function makeRow(frameId){
  const d=document.createElement('div');
  d.className='row'; d.dataset.frame=frameId;
  d.innerHTML=`
    <div class="bullet defaultBullet"></div>
    <input class="stop" placeholder="Enter stop" autocomplete="off" autocorrect="off" spellcheck="false">
    <span class="material-icons drag" title="Drag to reorder">drag_indicator</span>
    <span class="remove" title="Remove stop">×</span>`;
  d.querySelector('.remove').onclick=()=>{d.remove(); renumber(); scheduleAutoCompute(120,false); buildLocalTimeline(frameId);};
  d.addEventListener('click',rowSelectToggle);
  attachInputEvents(d.querySelector('.stop'));
  return d;
}
function addRowToFrame(frameId,focus=true,select=false){
  const list=document.getElementById('frame-'+frameId);
  const row=makeRow(frameId); list.appendChild(row);
  renumber(); buildLocalTimeline(frameId);
  if(focus) row.querySelector('.stop').focus({preventScroll:true});
  if(select) setSelected(row,true);
  return row;
}
function ensureFourIfNoFilled(frameId){
  const list=document.getElementById('frame-'+frameId);
  const rows=[...list.querySelectorAll('.row')];
  const filled=rows.filter(r=>r.querySelector('.stop').value.trim()).length;
  if(filled===0){
    // normalize to exactly 4 blanks
    list.innerHTML='';
    for(let i=0;i<DEFAULT_ROWS_PER_FRAME;i++) list.appendChild(makeRow(frameId));
  }
}

/* =================== TIMELINE IS NOW FUSED (no global timeline) =================== */

/* =================== SELECT / DELETE / NUMBERING =================== */
function rowSelectToggle(e){
  if(!(e.ctrlKey||e.metaKey)) return;
  e.currentTarget.classList.toggle('selected');
}
function setSelected(row,on){
  document.querySelectorAll('.row.selected').forEach(r=>r.classList.remove('selected'));
  if(on) row.classList.add('selected');
}

function renumber(){
  // Only filled rows get letters; empty rows keep neutral bullets => prevents letter "jumping"
  const rows=[...document.querySelectorAll('.row')];
  const filled=rows.filter(r=>r.querySelector('.stop').value.trim());
  filled.forEach((r,i)=>{
    const letter=colourCycle[i%colourCycle.length];
    const b=r.querySelector('.bullet');
    b.textContent=letter;
    b.className='bullet '+letter;
  });
  // reset empties
  rows.filter(r=>!r.querySelector('.stop').value.trim()).forEach(r=>{
    const b=r.querySelector('.bullet'); b.textContent=''; b.className='bullet defaultBullet';
  });
}

/* =================== INPUT / AUTOCOMPLETE =================== */
function attachInputEvents(inp){
  inp.addEventListener('mousedown',ev=>{
    if(document.activeElement!==inp){ ev.preventDefault(); inp.focus({preventScroll:true}); setTimeout(()=>inp.select(),0); }
  });
  inp.addEventListener('focus',e=>{ inp.closest('.row').classList.add('focused'); setTimeout(()=>e.target.select(),0); });
  inp.addEventListener('blur',()=>inp.closest('.row').classList.remove('focused'));

  inp.addEventListener('input',()=>{ inp.dataset.dirty='1'; inp.dataset.lat=''; inp.dataset.lng=''; scheduleAutoCompute(220,false); });

  inp.addEventListener('keydown',e=>{
    if(e.key==='Tab'&&!e.shiftKey){e.preventDefault();acceptTopPrediction(inp);}
    else if(e.key==='Enter'){e.preventDefault();acceptTopPrediction(inp);}
  });

  inp.addEventListener('paste',e=>multiPasteAcrossFrames(e, inp));

  const ac=new google.maps.places.Autocomplete(inp,{
    fields:['formatted_address','geometry','place_id'],
    types:['address'], componentRestrictions:{country:'ca'}, bounds:OK_BOUNDS, strictBounds:true
  });
  ac.addListener('place_changed',()=>{
    const p=ac.getPlace();
    if(p?.geometry){
      inp.value=p.formatted_address||inp.value;
      inp.dataset.lat=p.geometry.location.lat();
      inp.dataset.lng=p.geometry.location.lng();
      delete inp.dataset.dirty;
      scheduleAutoCompute(90,true);
    }
  });
}

function acceptTopPrediction(input){
  if (input.dataset.lat && input.dataset.lng){
    delete input.dataset.dirty; scheduleAutoCompute(0,true);
    const next=nextInput(input); if(next) next.focus({preventScroll:true});
    return;
  }
  acService.getPlacePredictions(
    {input:input.value, componentRestrictions:{country:'ca'}, types:['address'], locationBias:OK_BOUNDS},
    (preds,status)=>{
      if (status !== google.maps.places.PlacesServiceStatus.OK || !preds?.length){
        const nx=nextInput(input); if(nx) nx.focus({preventScroll:true}); scheduleAutoCompute(0,false); return;
      }
      placeSvc.getDetails({placeId:preds[0].place_id, fields:['formatted_address','geometry']},
        (place, st)=>{
          if (st === google.maps.places.PlacesServiceStatus.OK && place?.geometry){
            input.value=place.formatted_address||input.value;
            input.dataset.lat=place.geometry.location.lat();
            input.dataset.lng=place.geometry.location.lng();
            delete input.dataset.dirty;
          }
          const nx=nextInput(input); if(nx) nx.focus({preventScroll:true});
          scheduleAutoCompute(0,true);
        });
    });
}
function nextInput(current){
  const all=[...document.querySelectorAll('input.stop')];
  const idx=all.indexOf(current); return all[idx+1];
}

/* =================== SHIFT / VISIBILITY =================== */
function toggleFrame(id, iconEl){
  const el=document.querySelector(`.frame[data-frame="${id}"]`);
  const collapsed=el.classList.toggle('collapsed');
  if(!collapsed) { ensureFourIfNoFilled(id); buildLocalTimeline(id); }
  if(iconEl) iconEl.textContent = collapsed ? 'visibility_off' : 'visibility';
}

function updateToggleChips(){
  const d=document.getElementById('toggleDay');   if(d) d.classList.toggle('active',dayVisible);
  const n=document.getElementById('toggleNight'); if(n) n.classList.toggle('active',nightVisible);
}
function toggleShift(which){
  if(which==='day') dayVisible=!dayVisible;
  if(which==='night') nightVisible=!nightVisible;
  applyShiftVisibility();
}
function applyShiftVisibility(){
  FRAMES.forEach(fr=>{
    const sec=document.querySelector(`.frame[data-frame="${fr.id}"]`);
    const vis=(fr.shift==='day'&&dayVisible)||(fr.shift==='night'&&nightVisible);
    sec.style.display=vis?'grid':'none';
    if(vis) ensureFourIfNoFilled(fr.id);
    if(vis) buildLocalTimeline(fr.id);
  });
  updateToggleChips();
  renumber();
}

function buildAddrBar(){
  Sortable.create(document.getElementById('addrList'),{
    handle:'.drag',animation:150,
    onEnd:()=>{renumber();scheduleAutoCompute(120,false);}
  });
  document.getElementById('addrAdd').onclick=()=>{const r=addRowToAddrBar(true,false); r && r.querySelector('.stop').focus({preventScroll:true});};
  document.getElementById('toggleDay').onclick=()=>toggleShift('day');
  document.getElementById('toggleNight').onclick=()=>toggleShift('night');
}
function addRowToAddrBar(focus=true,select=false){
  const list=document.getElementById('addrList');
  const row=makeRow(0);list.appendChild(row);renumber();
  if(select) setSelected(row,true);
  if(focus) row.querySelector('.stop').focus({preventScroll:true});
  return row;
}

/* =================== ROUTING / OPTIMIZATION =================== */
const scheduleAutoCompute=(ms=120, allowResolve=false)=>{
  clearTimeout(autoTimer); autoResolveNext = allowResolve; autoTimer=setTimeout(()=>autoCompute(),ms);
};

const TEARDROP_PATH = "M0,-28 C-8,-28 -14,-22 -14,-14 c0,11 14,28 14,28 s14,-17 14,-28 C14,-22 8,-28 0,-28 z";

function clearDirections(){dirRend.set('directions',null);dirRend.setMap(null);dirRend.setMap(map);clearRouteMarkers();}
function addPreviewPin(latlng,label){
  const marker=new google.maps.Marker({
    position:latlng,map,
    label:{text:label,color:'#fff',fontSize:'16px',fontWeight:'700'},
    icon:{path:TEARDROP_PATH,scale:1,fillColor:'#4285F4',fillOpacity:1,strokeWeight:1.5,strokeColor:'#263238',labelOrigin:new google.maps.Point(0,-16),anchor:new google.maps.Point(0,0)}
  });
  previewPins.push(marker);
}
function clearPreviewPins(){previewPins.forEach(m=>m.setMap(null));previewPins=[];}

function drawRouteMarkers(points,rows){
  points.forEach((p,i)=>{
    if(!p) return;
    const b=rows[i]?.querySelector('.bullet'); const letter=b?(b.textContent||'').trim():'';
    const classLetter=/^[A-Z]$/.test(letter)?letter:null;
    const varName=classLetter?`--clr${classLetter}`:'--clrDefault';
    const color=getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
    const marker=new google.maps.Marker({
      position:p,map,
      label:{text:letter,color:'#fff',fontSize:'16px',fontWeight:'700'},
      icon:{path:TEARDROP_PATH,scale:1,fillColor:color||'#607d8b',fillOpacity:1,strokeWeight:1.5,strokeColor:'#263238',labelOrigin:new google.maps.Point(0,-16),anchor:new google.maps.Point(0,0)}
    });
    routeMarkers.push(marker);
  });
}
function clearRouteMarkers(){routeMarkers.forEach(m=>m.setMap(null));routeMarkers=[];}

/* Resolve helpers */
async function resolveAddress(text){
  const prediction = await new Promise(res=>{
    acService.getPlacePredictions(
      {input:text, componentRestrictions:{country:'ca'}, types:['address'], locationBias:OK_BOUNDS},
      (preds,status)=>{res(status===google.maps.places.PlacesServiceStatus.OK && preds?.length?preds[0]:null);}
    );
  });
  if(prediction){
    const place = await new Promise(res=>{
      placeSvc.getDetails({placeId:prediction.place_id, fields:['formatted_address','geometry']},
        (p,st)=>res(st===google.maps.places.PlacesServiceStatus.OK?p:null));
    });
    if(place?.geometry && OK_BOUNDS.contains(place.geometry.location)){
      return {lat:place.geometry.location.lat(),lng:place.geometry.location.lng(),formatted:place.formatted_address};
    }
  }
  return await geocodeSmart(text);
}
function geocodeSmart(addr,attempt=0){
  return new Promise(res=>{
    geocoder.geocode({address:addr,componentRestrictions:{country:'CA'},bounds:OK_BOUNDS,region:'CA'},
      (results,status)=>{
        if(status==='OK'&&results[0]){
          const loc=results[0].geometry.location;
          if(!OK_BOUNDS.contains(loc)){ res(null); }
          else res({lat:loc.lat(),lng:loc.lng(),formatted:results[0].formatted_address});
        }else if(status==='OVER_QUERY_LIMIT' && attempt<5){
          setTimeout(()=>geocodeSmart(addr,attempt+1).then(res), 250*(attempt+1));
        }else res(null);
      });
  });
}
async function ensureCoords(rows,{parallel=false}={}){
  const tasks = rows.map(row=>async ()=>{
    const inp=row.querySelector('.stop');
    row.classList.remove('invalid');
    if(!inp.value) return true;
    if(inp.dataset.lat && inp.dataset.lng) return true;
    const out = await resolveAddress(inp.value);
    if(out){ inp.dataset.lat=out.lat; inp.dataset.lng=out.lng; inp.value=out.formatted; delete inp.dataset.dirty; return true; }
    row.classList.add('invalid'); inp.placeholder='Unrecognised – edit me'; return false;
  });

  if(!parallel){
    for(const t of tasks){ const ok=await t(); if(!ok) return false; }
    return true;
  }else{
    const CONC=4; let i=0, okAll=true;
    await Promise.all(Array.from({length:CONC},async ()=> {
      while(i<tasks.length){ const my=i++; const ok=await tasks[my](); if(!ok) okAll=false; }
    }));
    return okAll;
  }
}

function getOrderedRows(){
  // in fused view we keep order: all visible frames in FRAMES order; only filled rows
  const rows=[];
  FRAMES.forEach(f=>{
    const sec=document.querySelector(`.frame[data-frame="${f.id}"]`);
    const vis=(sec && sec.style.display!=='none' && !sec.classList.contains('collapsed'));
    if(!vis) return;
    rows.push(...[...document.getElementById('frame-'+f.id).querySelectorAll('.row')]
      .filter(r=>r.querySelector('.stop').value.trim()));
  });
  return rows;
}

/* Remove empty rows that lie before the last filled row inside a frame */
function compactEmptiesWithinFrame(frameId){
  const list=document.getElementById('frame-'+frameId);
  const rows=[...list.querySelectorAll('.row')];
  let lastFilled=-1;
  for(let i=rows.length-1;i>=0;i--){
    if(rows[i].querySelector('.stop').value.trim()){ lastFilled=i; break; }
  }
  if(lastFilled>=0){
    for(let i=0;i<lastFilled;i++){
      const r=rows[i]; if(!r.querySelector('.stop').value.trim()) r.remove();
    }
  }
}

/* Paste across subsequent frames (same shift) without creating stray empties */
async function multiPasteAcrossFrames(e, inputEl){
  const clip=(e.clipboardData||window.clipboardData).getData('text');
  const lines=clip.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  if(lines.length<=1) return;   // let default paste happen for single line
  e.preventDefault();

  const startRow=inputEl.closest('.row');
  const startFrameId=+startRow.dataset.frame;
  const startFrame=FRAMES.find(f=>f.id===startFrameId);
  const shift=startFrame.shift;

  // build frame chain for this shift
  const chain=FRAMES.filter(f=>f.shift===shift && f.id>=startFrameId).map(f=>f.id);

  // place addresses into existing rows only; overflow moves to next frames.
  let cursorRow=startRow, frameIdx=0, lineIdx=0;

  while(lineIdx<lines.length && frameIdx<chain.length){
    const fid=chain[frameIdx];
    const list=document.getElementById('frame-'+fid);
    let rows=[...list.querySelectorAll('.row')];

    // find position to start in this frame
    let pos=0;
    if(fid===startFrameId){
      pos=rows.indexOf(startRow);
    }

    for(let i=pos; i<rows.length && lineIdx<lines.length; i++){
      const r=rows[i]; const inp=r.querySelector('.stop');
      if(!inp.value.trim()){ inp.value=lines[lineIdx++]; inp.dataset.lat=''; inp.dataset.lng=''; inp.dataset.dirty='1'; }
    }

    // if still more lines and this is the last frame in shift → allow creating FILLED rows here
    if(lineIdx<lines.length && frameIdx===chain.length-1){
      while(lineIdx<lines.length){
        const newRow=addRowToFrame(fid,false,false);
        const inp=newRow.querySelector('.stop'); inp.value=lines[lineIdx++]; inp.dataset.lat=''; inp.dataset.lng=''; inp.dataset.dirty='1';
      }
    }

    frameIdx++;
    cursorRow=null;
  }

  // compact empties between filled rows in affected frames
  chain.forEach(fid=>compactEmptiesWithinFrame(fid));

  renumber();
  await ensureCoords(getOrderedRows(),{parallel:true});
  scheduleAutoCompute(0,true);
}

/* Main autoCompute */
async function autoCompute(){
  const rows=getOrderedRows();
  const msg=document.getElementById('msg');

  if(rows.length===0){ clearPreviewPins(); clearDirections(); msg.textContent=''; return; }

  if(rows.some(r=>!r.querySelector('.stop').dataset.lat)){
    if(autoResolveNext){ await ensureCoords(rows,{parallel:true}); autoResolveNext=false; }
    else{ clearDirections(); return; }
  }

  if(rows.length===1){
    clearDirections(); clearPreviewPins();
    const inp=rows[0].querySelector('.stop');
    addPreviewPin({lat:+inp.dataset.lat,lng:+inp.dataset.lng}, rows[0].querySelector('.bullet').textContent||'A');
    msg.textContent='';
  }else{
    clearPreviewPins(); await rebuildRoute();
  }
}

/* Rebuild directions on map */
async function rebuildRoute(){
  const rows=getOrderedRows();
  const msg=document.getElementById('msg');
  if(rows.length<2){ msg.textContent=''; clearDirections(); return; }

  const ok=await ensureCoords(rows,{parallel:true});
  if(!ok){ msg.textContent='One or more stops can’t be located – please edit.'; return; }

  const locs=rows.map(r=>({lat:+r.querySelector('.stop').dataset.lat,lng:+r.querySelector('.stop').dataset.lng}));
  return new Promise(resolve=>{
    dirSvc.route({
      origin:locs[0], destination:locs[locs.length-1],
      waypoints:locs.slice(1,-1).map(l=>({location:l,stopover:true})),
      travelMode:'DRIVING'
    },(res,stat)=>{
      if(stat!=='OK'){ msg.textContent='Route error: '+stat; clearDirections(); resolve(); return; }
      msg.textContent=`Total Distance ${ (res.routes[0].legs.reduce((a,l)=>a+l.distance.value,0)/1000).toFixed(1) } km | ≈ ${ Math.round(res.routes[0].legs.reduce((a,l)=>a+l.duration.value,0)/60) } min`;
      dirRend.setDirections(res);
      clearRouteMarkers(); drawRouteMarkers(locs, rows);
      resolve();
    });
  });
}

/* =================== DISTANCE / TSP (unchanged core) =================== */
function buildDistanceMatrix(points){
  const n=points.length; const D=Array.from({length:n},()=>Array(n).fill(0));
  for(let i=0;i<n;i++){ for(let j=i+1;j<n;j++){ const d=haversine(points[i],points[j]); D[i][j]=D[j][i]=d; } }
  return D;
}
function haversine(a,b){
  const R=6371, toRad=x=>x*Math.PI/180;
  const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
  const s=Math.sin(dLat/2)**2+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(s));
}
function orderCost(order,D){ let c=0; for(let i=0;i<order.length-1;i++) c+=D[order[i]][order[i+1]]; return c; }
function nearestNeighbour(D,start=0){
  const n=D.length, vis=Array(n).fill(false), ord=[start]; vis[start]=true;
  for(let k=1;k<n;k++){ const last=ord[ord.length-1]; let best=Infinity,idx=-1;
    for(let j=0;j<n;j++){ if(!vis[j] && D[last][j]<best){best=D[last][j]; idx=j;} }
    ord.push(idx); vis[idx]=true;
  }
  return ord;
}
function twoOpt(order,D){
  const n=order.length; let improved=true;
  while(improved){ improved=false;
    for(let i=1;i<n-2;i++){ for(let j=i+1;j<n-1;j++){
      const a=order[i-1],b=order[i],c=order[j],d=order[j+1];
      if(D[a][b]+D[c][d] > D[a][c]+D[b][d]){ order.splice(i,j-i+1,...order.slice(i,j+1).reverse()); improved=true; }
    }}
  } return order;
}
function solveTSPWithMatrix(D,{fixedStart=null,fixedEnd=null}={}){
  const n=D.length; let start=fixedStart!=null?fixedStart:0; let ord=twoOpt(nearestNeighbour(D,start),D);
  if(fixedEnd!=null && ord[ord.length-1]!==fixedEnd){
    let best=ord, bestCost=orderCost(ord,D);
    for(let s=0;s<n;s++){ const r=[...ord.slice(s),...ord.slice(0,s)]; if(r[r.length-1]!==fixedEnd) continue;
      const c=orderCost(r,D); if(c<bestCost){best=r; bestCost=c;} }
    ord=best;
  }
  if(fixedStart!=null && ord[0]!==fixedStart){ const idx=ord.indexOf(fixedStart); if(idx>-1) ord=[...ord.slice(idx),...ord.slice(0,idx)]; }
  return ord;
}

/* =================== OPTIMIZERS =================== */
async function globalOptimizeRoute(){
  const rows=getOrderedRows(); const msg=document.getElementById('msg');
  if(rows.length<3){ await rebuildRoute(); return; }
  const ok=await ensureCoords(rows,{parallel:true});
  if(!ok){msg.textContent='One or more stops can’t be located – please edit.';return;}
  const pts=rows.map(r=>({lat:+r.querySelector('.stop').dataset.lat,lng:+r.querySelector('.stop').dataset.lng}));
  const D=buildDistanceMatrix(pts);
  const ord=solveTSPWithMatrix(D);
  const parent=rows[0].parentElement;
  ord.forEach(i=>parent.appendChild(rows[i]));
  renumber(); await rebuildRoute();
}

async function optimizeByFramesTwoPass(){
  // no auto-hide here (per latest requirement)
  const visFrames=FRAMES.filter(f=>{
    const sec=document.querySelector(`.frame[data-frame="${f.id}"]`);
    return (sec && sec.style.display!=='none' && !sec.classList.contains('collapsed'));
  });

  const framesData=[];
  for(const fr of visFrames){
    const list=document.getElementById('frame-'+fr.id);
    const rows=[...list.querySelectorAll('.row')].filter(r=>r.querySelector('.stop').value.trim());
    if(rows.length<2){ framesData.push({fr,list,rows,pts:[],D:null,baseOrder:null,baseCost:0}); continue; }
    const ok=await ensureCoords(rows,{parallel:true}); if(!ok) return;
    const pts=rows.map(r=>({lat:+r.querySelector('.stop').dataset.lat,lng:+r.querySelector('.stop').dataset.lng}));
    const D=buildDistanceMatrix(pts);
    const ord=solveTSPWithMatrix(D);
    const baseCost=orderCost(ord,D);
    framesData.push({fr,list,rows,pts,D,baseOrder:ord,baseCost});
  }

  // apply internal best order per frame
  framesData.forEach(fd=>{
    if(fd.rows.length<2) return; const ord=fd.baseOrder; ord.forEach(i=>fd.list.appendChild(fd.rows[i]));
  });

  renumber(); await rebuildRoute();
}

/* =================== INIT =================== */
window.routePlannerInit=()=>{
  map=new google.maps.Map(document.getElementById('map'),{
    center:{lat:49.8879,lng:-119.4960}, zoom:10,
    mapTypeControl:false,streetViewControl:true,fullscreenControl:true,tilt:0
  });

  OK_BOUNDS = new google.maps.LatLngBounds(
    new google.maps.LatLng(49.60,-119.80),
    new google.maps.LatLng(50.20,-119.15)
  );

  new google.maps.KmlLayer({
    url:'https://circuitsagexy.github.io/okanagan-map/r5a1LjX92e-djkvc12df/okanagan.kmz',
    map, preserveViewport:true, suppressInfoWindows:true, screenOverlays:false, clickable:false, zIndex:0
  });

  dirSvc=new google.maps.DirectionsService();
  dirRend=new google.maps.DirectionsRenderer({map,suppressMarkers:true});
  geocoder=new google.maps.Geocoder();
  acService=new google.maps.places.AutocompleteService();
  placeSvc=new google.maps.places.PlacesService(map);

  buildFrameBuckets(); buildAddrBar();

  // Start with both shifts visible; F1 toggles day, F2 toggles night
  document.getElementById('route').onclick=()=>{autoResolveNext=true; rebuildRoute();};
  document.getElementById('optAll').onclick=()=>{autoResolveNext=true; globalOptimizeRoute();};
  document.getElementById('optFrames').onclick=()=>{autoResolveNext=true; optimizeByFramesTwoPass();};
  document.getElementById('flatRoute').onclick=()=>{autoResolveNext=true; rebuildRoute();};
  document.getElementById('flatOpt').onclick=()=>{autoResolveNext=true; globalOptimizeRoute();};

  const sv = map.getStreetView();
  sv.addListener('visible_changed', () => {
    document.getElementById('svBack').style.display = sv.getVisible() ? 'block' : 'none';
  });
  document.getElementById('svBack').onclick = () => sv.setVisible(false);

  (function attachFunctionKeyTrap(){
    function onDown(e){
      if(!['F1','F2','F3'].includes(e.key)) return;
      e.preventDefault(); e.stopPropagation(); if(e.repeat) return;
      if(e.key==='F1') toggleShift('day');
      else if(e.key==='F2') toggleShift('night');
      else document.querySelectorAll('.row .remove').forEach(btn=>btn.click()); // quick clear
    }
    function onUp(e){ if(!['F1','F2','F3'].includes(e.key)) return; e.preventDefault(); e.stopPropagation(); }
    window.addEventListener('keydown', onDown, {capture:true, passive:false});
    window.addEventListener('keyup',   onUp,   {capture:true, passive:false});
    document.onhelp = () => false; window.onhelp = () => false;
  })();

  window.addEventListener('resize', ()=> {
    clearTimeout(window.__rb); window.__rb=setTimeout(()=>FRAMES.forEach(f=>buildLocalTimeline(f.id)), 120);
  });

  if(window.__mapsApiReady){ /* maps already loaded */ }
};
</script>
</body>
</html>
