<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Okanagan Route Planner</title>

<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<style>
html,body,#map{height:100%;margin:0;font-family:Roboto,Arial,sans-serif}
#panel{position:absolute;top:0;left:0;z-index:5;width:340px;max-height:100%;
       background:#fff;padding:16px;border-right:1px solid #ddd;
       box-shadow:0 0 6px rgba(0,0,0,.25);overflow:auto}
.row{display:flex;align-items:center;margin:10px 0}
.bullet{width:20px;height:20px;border-radius:50%;line-height:20px;text-align:center;
        font-weight:600;font-size:12px;color:#fff;margin-right:8px}
.A{background:#4285F4}.B{background:#0F9D58}.C{background:#F4B400}.D{background:#DB4437}
.defaultBullet{background:#607d8b}
input.stop{flex:1;height:38px;border:1px solid #ccc;border-radius:4px;padding:4px 6px;font-size:14px}
.drag{cursor:grab;margin-left:6px;color:#666}
.remove{cursor:pointer;margin-left:4px;font-size:20px;line-height:20px;color:#c00}
#add{margin:8px 0 14px 28px;padding:6px 10px}
#route,#opt,#layersBtn{margin-left:8px;padding:8px 14px}
#msg{margin:10px 0;color:#0066cc;font-weight:500}

/* ── slide‑in drawer for KML layers ── */
#layerDrawer{position:absolute;top:0;right:-260px;width:260px;max-height:100%;
  background:#fff;border-left:1px solid #ddd;box-shadow:-2px 0 6px rgba(0,0,0,.25);
  padding:14px 12px 10px;overflow:auto;transition:right .25s ease;z-index:6}
#layerDrawer.open{right:0}
#layerDrawer h3{margin:0 0 8px;font-size:16px}
#layerDrawer .close{position:absolute;top:10px;right:10px;cursor:pointer;font-size:18px}
.layerRow{display:flex;align-items:center;margin:6px 0;font-size:14px}
.layerRow span.name[contenteditable]{outline:none;border-bottom:1px dashed transparent}
.layerRow span.name[contenteditable]:focus{border-bottom-color:#999}
.layerRow .trash{cursor:pointer;margin-left:4px;font-size:18px;color:#c00}
</style>
</head>
<body>

<div id="panel">
  <div id="stops"></div>
  <button id="add">+ Add stop</button>
  <button id="route">Route</button>
  <button id="opt">Optimize</button>
  <button id="layersBtn">Layers</button>
  <div id="msg"></div>
  <small>Hold <b>Ctrl</b> and click the map to add way‑points interactively.</small>
</div>

<div id="map"></div>

<!-- drawer -->
<div id="layerDrawer">
  <span class="material-icons close" title="Hide">close</span>
  <h3>Map layers</h3>
  <div id="layers"></div>
  <input id="addKml" placeholder="Paste KML / KMZ URL then ↵"
         style="width:100%;margin-top:8px;padding:4px">
  <small style="color:#666">Colours come from the KML file.</small>
</div>

<script type="module">
import Sortable from 'https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/+esm';

const labels='ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
let map,dirSvc,dirRend;

/* ---------- helpers & UI for stops ---------- */
function makeRow(i){
  const d=document.createElement('div');d.className='row';
  d.innerHTML=`<div class="bullet ${labels[i]}">${labels[i]}</div>
    <input class="stop" placeholder="Enter stop">
    <span class="material-icons drag">drag_indicator</span>
    <span class="remove">×</span>`;
  d.querySelector('.remove').onclick=()=>{d.remove();renumber();rebuildRoute();};
  return d;
}
const renumber=()=>[...document.querySelectorAll('.row')].forEach((r,i)=>{
  const b=r.querySelector('.bullet');b.textContent=labels[i]||'?';
  b.className='bullet '+(i<4?labels[i]:'defaultBullet');
});
const addresses=()=>[...document.querySelectorAll('input.stop')].map(e=>e.value.trim()).filter(Boolean);

/* ---------- drawer utilities ---------- */
const drawer=document.getElementById('layerDrawer');
const toggleDrawer=(f)=>drawer.classList.toggle('open',f===undefined?!drawer.classList.contains('open'):f);
function addKmlLayer(name,url){
  const layer=new google.maps.KmlLayer({url,map:null,preserveViewport:true});
  const row=document.createElement('div');row.className='layerRow';
  row.innerHTML=`<input type="checkbox">
    <span class="name" contenteditable="true">${name}</span>
    <span class="material-icons trash">delete</span>`;
  row.querySelector('input').onchange=e=>layer.setMap(e.target.checked?map:null);
  row.querySelector('.trash').onclick=()=>{layer.setMap(null);row.remove();};
  document.getElementById('layers').append(row);
}

/* ---------- init called by Google script ---------- */
window.init=()=>{
  /* base map */
  map=new google.maps.Map(document.getElementById('map'),
        {center:{lat:49.9,lng:-119.5},zoom:9});
  new google.maps.KmlLayer({
    url:'okanagan.kmz',map,preserveViewport:true
  });

  dirSvc=new google.maps.DirectionsService();
  dirRend=new google.maps.DirectionsRenderer({map});

  /* stops UI */
  const list=document.getElementById('stops');
  list.append(makeRow(0),makeRow(1));
  Sortable.create(list,{handle:'.drag',animation:150,onEnd:()=>{renumber();rebuildRoute();}});
  const attach=input=>{
    input.addEventListener('focus',e=>setTimeout(()=>e.target.select(),0));
    input.addEventListener('paste',e=>{
      const lines=(e.clipboardData||window.clipboardData).getData('text').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      if(lines.length<=1)return;e.preventDefault();
      const rows=[...list.children],start=rows.indexOf(input.parentElement);
      while(list.children.length<start+lines.length&&list.children.length<labels.length){
        const r=makeRow(list.children.length);list.appendChild(r);attach(r.querySelector('.stop'));
      }
      lines.forEach((t,i)=>{if(start+i<labels.length)list.children[start+i].querySelector('.stop').value=t;});
      renumber();rebuildRoute();
    });
    new google.maps.places.Autocomplete(input,{fields:['formatted_address','geometry'],componentRestrictions:{country:'ca'}});
  };
  [...list.querySelectorAll('input.stop')].forEach(attach);
  document.getElementById('add').onclick=()=>{if(list.children.length<labels.length){const r=makeRow(list.children.length);list.appendChild(r);attach(r.querySelector('.stop'));renumber();}};
  document.getElementById('route').onclick=()=>rebuildRoute();
  document.getElementById('opt').onclick  =()=>optimizeRoute();

  /* routing */
  function rebuildRoute(){
    const pts=addresses(),msg=document.getElementById('msg');
    if(pts.length<2){msg.textContent='';dirRend.setDirections({});return;}
    dirSvc.route({origin:pts[0],destination:pts[pts.length-1],
      waypoints:pts.slice(1,-1).map(l=>({location:l,stopover:true})),travelMode:'DRIVING'},
      (res,stat)=>{if(stat==='OK')dirRend.setDirections(res);});
  }
  function optimizeRoute(){
    const pts=addresses();if(pts.length<3){rebuildRoute();return;}
    dirSvc.route({origin:pts[0],destination:pts[0],
      waypoints:pts.slice(1).map(l=>({location:l,stopover:true})),
      travelMode:'DRIVING',optimizeWaypoints:true},
      (res,s)=>{if(s==='OK'){const order=res.routes[0].waypoint_order,rows=[...list.children];order.forEach(i=>list.append(rows[i+1]));renumber();rebuildRoute();}});
  }

  /* drawer controls */
  addKmlLayer('Okanagan Areas','okanagan.kmz');
  document.getElementById('layersBtn').onclick=()=>toggleDrawer(true);
  drawer.querySelector('.close').onclick=()=>toggleDrawer(false);
  document.addEventListener('keydown',e=>{if(e.key==='F1'){e.preventDefault();toggleDrawer();}});
  document.getElementById('addKml').addEventListener('keydown',e=>{
    if(e.key!=='Enter')return;
    const url=e.target.value.trim();if(!url)return;
    addKmlLayer(prompt('Layer name?',url.split('/').pop())||'Unnamed',url);
    e.target.value='';});
};
</script>

<!-- Google script LAST so init is defined before callback -->
<script defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDnpSCHQWHr1neHALY-xddNne_S7f608co&callback=init&libraries=places,geometry">
</script>
</body>
</html>
