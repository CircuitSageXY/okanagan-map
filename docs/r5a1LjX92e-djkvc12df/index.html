<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Okanagan Route Planner</title>

<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap">

<style>
/* ---------- GLOBAL VARIABLES ---------- */
:root{
  --clrA:#4285F4; --clrB:#0F9D58; --clrC:#F4B400; --clrD:#DB4437;
  --clrE:#ab47bc; --clrF:#00acc1; --clrG:#ff7043; --clrH:#8d6e63;
  --clrDefault:#607d8b;

  --clrPanelBg:#ffffff; --clrPanelBorder:#d7d7d7; --clrPanelStripe:#2196f3;
  --clrPanelShadow:0 2px 8px rgba(0,0,0,.25);
  --clrInputBorder:#c7c7c7; --clrInputBg:#fff; --clrInputBgAlt:#fafafa;

  --radiusSm:4px; --radiusMd:6px; --radiusLg:10px;
  --transFast:.12s; --fontMain:Roboto,Arial,sans-serif;

  --f-early:#8BC34A; --f-late:#4CAF50; --f-lunch:#FFEB3B;
  --f-afternoon:#03A9F4; --f-supper:#FF9800;
  --f-evening:#BA68C8; --f-lateev:#F44336;

  --panelW:480px;
  --tlW:74px;
  --axis-w:4px;
  --tick-minor:#9e9e9e; --tick-major:#424242;

  --pxPerMin:2;

  /* Label theme â€” change this to #333 for grey/black or any hex you like */
  --label-accent:#5b46ff; /* dark purple */
}

/* ---------- BASICS ---------- */
html,body,#map{height:100%;margin:0;font-family:var(--fontMain);}
#map{backface-visibility:hidden;transform:translateZ(0);}
.hidden{display:none!important;}
.pac-container{ display:none !important; }  /* hide Google popup (we render our own) */

/* ---------- SIDE PANEL ---------- */
#panel{
  position:absolute;top:0;left:0;z-index:5;width:var(--panelW);height:100%;
  background:var(--clrPanelBg);border-right:1px solid var(--clrPanelBorder);
  box-shadow:var(--clrPanelShadow);border-top-right-radius:var(--radiusLg);
  border-bottom-right-radius:var(--radiusLg);display:flex;flex-direction:column;
}
#scroller{flex:1;overflow:auto;position:relative;padding:12px 12px 8px 0;}
#content{display:flex;align-items:flex-start;position:relative;}
#timelineCol{display:none;} #timeline{display:none;}

/* ---------- FRAMES ---------- */
#framesContainer{flex:1;min-width:0;}
.frame{
  border:1px solid var(--clrPanelBorder);border-radius:6px;margin-bottom:14px;background:#fff;
  box-shadow:0 1px 2px rgba(0,0,0,.08);position:relative;display:flex;flex-direction:column;
}
/* not sticky so timeline/inputs never get covered */
.frame-header{
  position:relative;top:auto;z-index:1;display:flex;align-items:center;gap:8px;padding:6px 10px;
  font-size:15px;font-weight:500;color:#000;border-bottom:1px solid #e0e0e0;background:#fafafa;
}
.frame-header .swatch{width:16px;height:16px;border-radius:3px;flex:none;}
.frame-hide{margin-left:auto;cursor:pointer;color:#666;font-size:20px;line-height:20px;}
.frame-hide:hover{color:#000;}
.frame.collapsed .frame-body,.frame.collapsed .addRowBtn{display:none;}
.frame.collapsed{opacity:.55;}
.frame.collapsed .frame-hide{color:#c00;}

.frame-body{
  display:grid;grid-template-columns: var(--tlW) 1fr;column-gap:12px;
  align-items:stretch; padding:6px 10px 8px 6px;
}

.frame-timeline{position:relative;}
.tl-axis{position:absolute;left:6px;width:var(--axis-w);background:#000;border-radius:2px;}
.tl-tick{position:absolute;left:0;width:100%;pointer-events:none;}
.tl-tick::before{content:"";position:absolute;left:calc(6px + var(--axis-w));width:6px;height:1px;background:var(--tick-minor);}
.tl-tick.bold::before{width:10px;background:var(--tick-major);}
.tl-label{position:absolute;left:18px;font-size:11px;color:#424242;background:rgba(255,255,255,.85);
  padding:0 2px;border-radius:2px;line-height:1;}
.nowMarker{
  position:absolute;left:calc(6px + var(--axis-w)/2);width:12px;height:12px;border:2px solid #000;background:#fff;border-radius:50%;
  transform:translate(-50%,-50%);box-shadow:0 0 4px rgba(0,0,0,.4);animation:pulse 2s infinite;z-index:3;}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(0,0,0,.35);}70%{box-shadow:0 0 0 6px rgba(0,0,0,0);}100%{box-shadow:0 0 0 0 rgba(0,0,0,0);}}

/* shaded band */
.tl-seg{position:absolute;left:0;right:0;border-radius:3px;opacity:.08;}

.frame-list{overflow:visible;flex:1 1 auto;}
.addRowBtn{display:none;}

/* colored borders per frame */
.frame[data-frame="0"]{border-left:4px solid var(--f-early);}
.frame[data-frame="1"]{border-left:4px solid var(--f-late);}
.frame[data-frame="2"]{border-left:4px solid var(--f-lunch);}
.frame[data-frame="3"]{border-left:4px solid var(--f-afternoon);}
.frame[data-frame="4"]{border-left:4px solid var(--f-afternoon);}
.frame[data-frame="5"]{border-left:4px solid var(--f-supper);}
.frame[data-frame="6"]{border-left:4px solid var(--f-evening);}
.frame[data-frame="7"]{border-left:4px solid var(--f-lateev);}

/* ---------- ROWS ---------- */
.row{display:flex;align-items:center;margin:8px 0;padding:4px 6px 4px 0;border-radius:var(--radiusMd);transition:background var(--transFast),box-shadow var(--transFast),outline var(--transFast);}
.row.focused{background:var(--clrInputBgAlt);box-shadow:0 0 0 2px rgba(33,150,243,.25);}
.row:hover:not(.focused):not(.selected){background:rgba(0,0,0,.04);}
.row.invalid input.stop{border-color:#e53935;background:#fff7f7;}
.row.selected{outline:3px solid rgba(33,150,243,.6);}

.bullet{
  min-width:24px;padding:0 6px;height:24px;border-radius:50%;
  line-height:24px;text-align:center;font-weight:600;font-size:13px;color:#fff;
  margin-right:8px;flex:none;box-shadow:0 0 0 2px rgba(255,255,255,.8),0 0 4px rgba(0,0,0,.35);}
.A{background:var(--clrA)} .B{background:var(--clrB)}
.C{background:var(--clrC)} .D{background:var(--clrD)}
.E{background:var(--clrE)} .F{background:var(--clrF)}
.G{background:var(--clrG)} .H{background:var(--clrH)}
.defaultBullet{background:var(--clrDefault)}

input.stop{
  flex:1;height:38px;border:1px solid var(--clrInputBorder);
  border-radius:var(--radiusSm);padding:4px 6px 4px 10px;font-size:14px;
  background:var(--clrInputBg);transition:border-color var(--transFast),box-shadow var(--transFast);}
input.stop:focus{outline:none;border-color:var(--clrPanelStripe);box-shadow:0 0 0 3px rgba(33,150,243,.25);}
.row[data-frame="0"] input.stop{border-left:4px solid var(--f-early);    padding-left:6px;}
.row[data-frame="1"] input.stop{border-left:4px solid var(--f-late);     padding-left:6px;}
.row[data-frame="2"] input.stop{border-left:4px solid var(--f-lunch);    padding-left:6px;}
.row[data-frame="3"] input.stop{border-left:4px solid var(--f-afternoon);padding-left:6px;}
.row[data-frame="4"] input.stop{border-left:4px solid var(--f-afternoon);padding-left:6px;}
.row[data-frame="5"] input.stop{border-left:4px solid var(--f-supper);   padding-left:6px;}
.row[data-frame="6"] input.stop{border-left:4px solid var(--f-evening);  padding-left:6px;}
.row[data-frame="7"] input.stop{border-left:4px solid var(--f-lateev);   padding-left:6px;}

.drag{cursor:grab;margin-left:6px;color:#666;font-size:22px;line-height:22px;padding:2px;border-radius:var(--radiusSm);}
.drag:hover{background:rgba(0,0,0,.08);} .drag:active{cursor:grabbing;}
.remove{
  cursor:pointer;margin-left:4px;font-size:20px;line-height:20px;color:#fff;
  width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center;
  background:var(--clrD);border-radius:var(--radiusSm);
  transition:transform var(--transFast),background var(--transFast);}
.remove:hover{background:#f75a4d;transform:scale(1.08);} .remove:active{transform:scale(.94);}

/* ---------- TOTALS ---------- */
#msg{
  position:sticky; bottom:0;margin:0; padding:8px 12px 10px 12px;
  color:#0b63c7;font-weight:700;font-size:16px;
  background:linear-gradient(to bottom, rgba(240,248,255,.6), rgba(240,248,255,.95));
  border-top:1px solid #d7d7d7; backdrop-filter:blur(2px);
}

/* ---------- FLAT MODE ---------- */
#panel.flat{width:auto;background:transparent;border:none;box-shadow:none;pointer-events:none;}
#panel.flat #content{display:none;}
#panel.flat #scroller{padding:12px;}
#panel.flat #msg{display:none;}

#addrBar{
  position:absolute;top:12px;left:12px;width:380px;z-index:8;
  background:rgba(255,255,255,.75);border:1px solid #d7d7d7;border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,.25);padding:12px 12px 10px 12px;
  pointer-events:auto;display:none;backdrop-filter:blur(2px);}
#addrBar.active{display:block;}
#addrBarHeader{display:flex;align-items:center;gap:8px;margin-bottom:6px;font-weight:500;font-size:15px;}
#addrTitle{flex:1;}
#addrToggles{display:flex;gap:6px;}
.toggleChip{padding:3px 10px;border-radius:14px;border:1px solid #bbb;font-size:12px;cursor:pointer;user-select:none;line-height:16px;display:inline-block;min-width:46px;text-align:center; background:#fff;}
.toggleChip.day  {border-color:var(--f-afternoon);color:var(--f-afternoon);}
.toggleChip.night{border-color:var(--f-evening);color:var(--f-evening);}
.toggleChip.active.day  {background:var(--f-afternoon);color:#fff;}
.toggleChip.active.night{background:var(--f-evening);color:#fff;}

/* Make Optimize look like a chip */
#flatButtons{display:flex;gap:8px;align-items:center;}
#flatOpt{all:unset;}
#flatOpt{display:inline-block; padding:3px 10px; border-radius:14px; border:1px solid #bbb; font-size:12px; line-height:16px; cursor:pointer; user-select:none; color:var(--clrB); border-color:var(--clrB); background:#fff;}
#flatOpt:hover{background:var(--clrB); color:#fff;}
#flatDelSel{background:#db4437;color:#fff;display:none;padding:6px 12px;border-radius:6px;border:none;cursor:pointer;}

/* ---------- OUR suggestion dropdown ---------- */
.sg{
  position:absolute; z-index:9999; background:#fff; border:1px solid #d2d2d2;
  border-radius:8px; box-shadow:0 8px 20px rgba(0,0,0,.15);
  overflow:auto; max-height:220px; display:none; min-width:260px;
}
.sg ul{list-style:none;margin:0;padding:4px 0;}
.sg li{padding:8px 12px;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:13px;}
.sg li:hover,.sg li.active{background:#e8f1fe;}
.sg small{opacity:.7;margin-left:6px;}

/* ---------- REGION LABEL OVERLAY (snappy + fun) ---------- */
.region-label{
  position:absolute; transform:translate(-50%,-100%); z-index:1000; pointer-events:auto;
  opacity:0;
}
@keyframes popIn {
  0%   { opacity:0; transform:translate(-50%,-96%) scale(.72); filter:saturate(0.9) }
  60%  { opacity:1; transform:translate(-50%,-114%) scale(1.05) }
  100% { opacity:1; transform:translate(-50%,-112%) scale(1.0) }
}
@keyframes popOut {
  0%   { opacity:1; transform:translate(-50%,-112%) scale(1) }
  100% { opacity:0; transform:translate(-50%,-96%) scale(.8) }
}
.region-label.show{ animation:popIn .15s cubic-bezier(.25,.85,.25,1.0) forwards; }
.region-label.leaving{ animation:popOut .11s cubic-bezier(.2,.7,.2,1) forwards; }

.region-card{
  position:relative; display:flex; align-items:center; gap:10px;
  background:linear-gradient(135deg, var(--accent, var(--label-accent)) 0%, #ffffff 68%);
  border:1px solid rgba(0,0,0,.10);
  border-radius:16px;
  box-shadow:0 12px 26px rgba(0,0,0,.22);
  padding:9px 12px;
  color:#131418;
}
.region-card::after{ /* pointer */
  content:""; position:absolute; left:24px; bottom:-8px;
  width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-top:8px solid rgba(255,255,255,0.95);
  filter:drop-shadow(0 2px 2px rgba(0,0,0,.12));
}
.region-accent{ width:9px; height:24px; border-left:9px solid var(--accent, var(--label-accent)); border-radius:5px;}
.region-title{
  font-weight:900; letter-spacing:.35px; text-transform:uppercase;
  font-size:14px; padding:3px 10px; border-radius:999px;
  background:rgba(255,255,255,.78); border:1px solid rgba(0,0,0,.06);
}
.region-close{ margin-left:auto; cursor:pointer; color:#444; font-size:18px; line-height:18px; }
.region-close:hover{ color:#000; }

/* CSSâ€‘level attempt to hide Visualâ€‘Search when not in shadow DOM */
.gm-style [aria-label*="Visual"],
.gm-style [title*="Visual"],
.gm-style [aria-label*="Lens"],
.gm-style [title*="Lens"]{ display:none !important; }
</style>

<script>
function init(){ if(window.routePlannerInit) window.routePlannerInit(); else window.__mapsApiReady=true; }
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDnpSCHQWHr1neHALY-xddNne_S7f608co&callback=init&libraries=places,geometry"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>

<body>
<div id="panel">
  <div id="scroller">
    <div id="content">
      <div id="timelineCol"><div id="timeline"></div></div>
      <div id="framesContainer"></div>
    </div>
    <div id="msg"></div>
  </div>
</div>

<!-- ---------- FLAT (directions list) ---------- -->
<div id="addrBar">
  <div id="addrBarHeader">
    <span id="addrTitle">Directions</span>
    <div id="addrToggles">
      <span id="toggleDay"   class="toggleChip day">Day</span>
      <span id="toggleNight" class="toggleChip night">Night</span>
    </div>
    <button id="addrAdd" title="Add stop">+</button>
  </div>
  <div id="addrList"></div>
  <div id="addrFooter">
    <div id="flatMsg"></div>
    <div id="flatButtons">
      <button id="flatOpt">Optimize</button>
      <button id="flatDelSel">Delete Selected</button>
    </div>
  </div>
</div>

<!-- our dropdown root -->
<div id="sgRoot" class="sg"><ul></ul></div>

<div id="map"></div>

<script>
/* =================== CONFIG / CONSTANTS =================== */
const BASE_EMPTY_PER_FRAME = 4;
const INITIAL_FLAT_ROWS    = 2;

/* label color mode: 'uniform' => use --label-accent; 'hash' => perâ€‘name hues */
const LABEL_COLOR_MODE = 'uniform';

const TOL_PCT = 0.03, TOL_KM = 0.30;

let map,dirSvc,dirRend,geocoder,acService,placeSvc;
let previewPins=[],routeMarkers=[];
let autoTimer=null, autoResolveNext=false;

/* Default view must be FLAT */
let dayVisible=false, nightVisible=false, flatMode=false;

let OK_BOUNDS;
const frameInitialized = new Map();

function hideAllAutocompleteUIs(){
  document.querySelectorAll('.pac-container').forEach(el=>{
    el.style.display='none';
    el.setAttribute('aria-hidden','true');
  });
}

/* ---------- Suggestion dropdown ---------- */
const SG = (function(){
  const root = document.getElementById('sgRoot');
  const list = root.querySelector('ul');
  let boundInput = null;
  let items = [];
  let hot = -1;

  function openFor(input, predictions){
    boundInput = input;
    items = predictions.slice(0,5).map(p=>({pred:p, text:p.description}));
    render(); position();
    root.style.display = items.length ? 'block' : 'none';
  }
  function render(){
    list.innerHTML = '';
    items.forEach((it, i)=>{
      const li = document.createElement('li');
      li.textContent = it.text;
      if(i===hot) li.classList.add('active');
      li.addEventListener('mousedown', ev=>{ ev.preventDefault(); ev.stopPropagation(); }, {capture:true});
      li.addEventListener('click', ()=> choose(i));
      list.appendChild(li);
    });
  }
  function position(){
    if(!boundInput) return;
    const r = boundInput.getBoundingClientRect();
    const top = r.bottom + window.scrollY + 4;
    const left = r.left + window.scrollX;
    root.style.top = top+'px';
    root.style.left = left+'px';
    root.style.minWidth = Math.max(260, r.width)+'px';
  }
  function hide(){
    root.style.display='none';
    boundInput=null; items=[]; hot=-1; list.innerHTML='';
  }
  function isOpen(){ return root.style.display==='block'; }
  function choose(idx){
    if(!boundInput || !items[idx]){ hide(); return; }
    const p = items[idx].pred;
    placeSvc.getDetails({placeId:p.place_id, fields:['formatted_address','geometry']},
      (place, st)=>{
        if(st===google.maps.places.PlacesServiceStatus.OK && place?.geometry){
          boundInput.value       = place.formatted_address || boundInput.value;
          boundInput.dataset.lat = place.geometry.location.lat();
          boundInput.dataset.lng = place.geometry.location.lng();
          delete boundInput.dataset.dirty;
          scheduleAutoCompute(0, true);
        }
        hide();
        safeFocus(boundInput);
      });
  }
  function move(delta){
    if(!isOpen() || !items.length) return;
    hot = ( (hot + delta + items.length) % items.length );
    render();
  }
  function chooseHot(){ if(hot<0) hot = 0; choose(hot); }

  window.addEventListener('scroll', ()=>{ if(isOpen()) position(); }, true);
  window.addEventListener('resize', ()=>{ if(isOpen()) position(); });

  return {openFor, hide, isOpen, move, chooseHot};
})();

/* debounce helper */
function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

/* Central Okanagan filter */
const OK_DESC = /(Kelowna|West Kelowna|Lake Country|Peachland)/i;

/* get predictions */
const fetchPredictions = debounce((text, cb)=>{
  if(!text || text.trim().length<3){ cb([]); return; }
  acService.getPlacePredictions(
    { input:text, types:['address'], componentRestrictions:{country:'ca'}, locationBias: OK_BOUNDS },
    (preds, status)=>{
      if(status !== google.maps.places.PlacesServiceStatus.OK || !preds){ cb([]); return; }
      const filtered = preds.filter(p=>OK_DESC.test(p.description)).slice(0,5);
      cb(filtered);
    }
  );
}, 120);

/* Focus helper */
function safeFocus(el){ if(!el) return; try{ el.focus({preventScroll:true}); }catch{} setTimeout(()=>{ try{ el.focus({preventScroll:true}); }catch{} },0); }

/* ---------- FRAMES ---------- */
const FRAMES=[
  {id:0,key:'early',     name:'AM Early',     start:'07:00', end:'09:00',  color:'var(--f-early)',     shift:'day'},
  {id:1,key:'late',      name:'AM Late',      start:'09:00', end:'11:00',  color:'var(--f-late)',      shift:'day'},
  {id:2,key:'lunch',     name:'Lunch',        start:'11:00', end:'13:00',  color:'var(--f-lunch)',     shift:'day'},
  {id:3,key:'afternoon', name:'Afternoon',    start:'13:00', end:'15:30',  color:'var(--f-afternoon)', shift:'day'},
  {id:4,key:'aftNight',  name:'Afternoon',    start:'13:30', end:'16:00',  color:'var(--f-afternoon)', shift:'night'},
  {id:5,key:'supper',    name:'Supper',       start:'16:00', end:'18:30',  color:'var(--f-supper)',    shift:'night'},
  {id:6,key:'evening',   name:'Evening',      start:'18:30', end:'21:00',  color:'var(--f-evening)',   shift:'night'},
  {id:7,key:'lateev',    name:'Late Evening', start:'21:00', end:'22:30',  color:'var(--f-lateev)',    shift:'night'}
];

/* ---------- TIMELINE ---------- */
const mins=(h,m)=>h*60+m;
const parseHM=t=>{const [h,m]=t.split(':').map(Number);return mins(h,m);};
const pad=n=>n.toString().padStart(2,'0');
let __buildingTimeline = false;
let __tl_req = 0, __tl_to = 0;
function scheduleTimelineBuild(){
  if(__tl_req) return;
  __tl_req = requestAnimationFrame(() => { __tl_req = 0; buildTimelineFromDOM(); });
}
function forceCloseAutocomplete(inp){
  try{ inp.dispatchEvent(new KeyboardEvent('keydown', {key:'Escape', bubbles:true})); }catch(e){}
  inp.blur(); hideAllAutocompleteUIs(); SG.hide();
}

/* =================== UI BUILD (frames/rows) =================== */
function setFrameCollapsed(id, collapse){
  const el=document.querySelector(`.frame[data-frame="${id}"]`);
  if(!el) return;
  if(collapse) el.classList.add('collapsed'); else el.classList.remove('collapsed');
  if(!collapse){ ensurePlaceholdersForFrame(id, {force:false}); buildTimelineForFrame(id); }
  renumber(); scheduleTimelineBuild();
}

function buildFrameBuckets(){
  const container=document.getElementById('framesContainer');

  FRAMES.forEach(fr=>{
    const sec=document.createElement('div');
    sec.className='frame';sec.dataset.frame=fr.id;sec.dataset.shift=fr.shift;

    const head=document.createElement('div');
    head.className='frame-header';
    head.innerHTML=`<span class="swatch" style="background:${fr.color}"></span>${fr.name} <span style="margin-left:10px;font-size:12px;color:#666">(${fr.start}â€“${fr.end})</span>`;
    const hideBtn=document.createElement('span');
    hideBtn.className='material-icons frame-hide';
    hideBtn.textContent='visibility_off';
    hideBtn.title='Hide / show this time frame';
    hideBtn.onclick=()=>setFrameCollapsed(fr.id, !sec.classList.contains('collapsed'));
    head.appendChild(hideBtn);
    sec.appendChild(head);

    const body=document.createElement('div');
    body.className='frame-body';

    const tl=document.createElement('div');
    tl.className='frame-timeline'; tl.id='timeline-frame-'+fr.id;
    body.appendChild(tl);

    const list=document.createElement('div');
    list.className='frame-list'; list.id='frame-'+fr.id;
    body.appendChild(list);

    sec.appendChild(body);

    const addBtn=document.createElement('button');
    addBtn.className='addRowBtn';addBtn.textContent='+ Add stop';
    addBtn.style.display='none';
    addBtn.onclick=()=>addRowToFrame(fr.id,true,false);
    sec.appendChild(addBtn);

    container.appendChild(sec);

    Sortable.create(list,{
      group:'stops', handle:'.drag', animation:150,
      onEnd:evt=>{
        evt.item.dataset.frame=list.parentElement.parentElement.dataset.frame;
        renumber(); scheduleAutoCompute(120,false); scheduleTimelineBuild();
      }
    });
  });

  renumber();

  const ro=new ResizeObserver(()=>scheduleTimelineBuild());
  document.querySelectorAll('.frame').forEach(f=>ro.observe(f));
  const mo=new MutationObserver(()=>{ clearTimeout(__tl_to); __tl_to=setTimeout(scheduleTimelineBuild,50); });
  document.querySelectorAll('.frame-list').forEach(fl=>mo.observe(fl,{childList:true,subtree:true}));
}

function rebalanceFrameHeights(){ if(flatMode) return; scheduleTimelineBuild(); }

function makeRow(frameId){
  const d=document.createElement('div');
  d.className='row';d.dataset.frame=frameId;
  d.innerHTML=`
    <div class="bullet defaultBullet">A</div>
    <input class="stop" placeholder="Enter stop" autocomplete="off" autocorrect="off" spellcheck="false">
    <span class="material-icons drag" title="Drag to reorder">drag_indicator</span>
    <span class="remove" title="Remove stop">Ã—</span>`;
  const del=d.querySelector('.remove');
  del.addEventListener('mousedown', e=>{ e.preventDefault(); e.stopPropagation(); }, true);
  del.addEventListener('click', e=>{
    e.preventDefault(); e.stopPropagation();
    d.remove();
    renumber();
    scheduleAutoCompute(120,false);
    scheduleTimelineBuild();
    showDeleteBtns();
  });
  d.addEventListener('click',rowSelectToggle);
  attachInputEvents(d.querySelector('.stop'));
  return d;
}
function addRowToFrame(frameId,focus=true,select=false){
  const list=document.getElementById('frame-'+frameId);
  const row=makeRow(frameId);list.appendChild(row);
  renumber();scheduleTimelineBuild();
  if(focus) safeFocus(row.querySelector('.stop'));
  if(select) setSelected(row,true);
  return row;
}
function insertRowAfter(currentRow){
  const frameId=+currentRow.dataset.frame;
  const newRow=makeRow(frameId);
  currentRow.insertAdjacentElement('afterend', newRow);
  renumber(); scheduleTimelineBuild();
  return newRow;
}
function ensurePlaceholdersForFrame(frameId,{force=false}={}){
  const list=document.getElementById('frame-'+frameId); if(!list) return;
  const sec=list.closest('.frame');
  const visible = sec.style.display!=='none' && !flatMode && !sec.classList.contains('collapsed');
  if(!visible) return;
  if(frameInitialized.get(frameId) && !force) return;

  frameInitialized.set(frameId,true);
  const cur=list.querySelectorAll('.row').length;
  for(let i=cur;i<BASE_EMPTY_PER_FRAME;i++) addRowToFrame(frameId,false,false);
}

/* =================== TIMELINE =================== */
function buildTimelineFromDOM(){
  if(flatMode) return;
  if(__buildingTimeline) return;
  __buildingTimeline = true;
  try{
    FRAMES.forEach(fr=>{
      const sec=document.querySelector(`.frame[data-frame="${fr.id}"]`);
      const visible=(fr.shift==='day'?dayVisible:nightVisible) &&
                     !sec.classList.contains('collapsed') &&
                     sec.style.display!=='none';
      const tl=document.getElementById('timeline-frame-'+fr.id);
      if(!tl) return;
      tl.innerHTML='';
      if(!visible) return;
      buildTimelineForFrame(fr.id);
    });
    renumber();
  } finally { __buildingTimeline = false; }
}
function buildTimelineForFrame(frameId){
  const meta=FRAMES.find(f=>f.id===frameId);
  const tl=document.getElementById('timeline-frame-'+frameId);
  const sec=document.querySelector(`.frame[data-frame="${frameId}"]`);
  const list=sec.querySelector('.frame-list');
  const h=list.offsetHeight||1;

  const seg=document.createElement('div');
  seg.className='tl-seg'; seg.style.top='0px'; seg.style.height=h+'px';
  seg.style.background = getComputedStyle(sec).borderLeftColor;
  tl.appendChild(seg);

  const axis=document.createElement('div');
  axis.className='tl-axis'; axis.style.top='0px'; axis.style.height=h+'px';
  tl.appendChild(axis);

  const startM=parseHM(meta.start), endM=parseHM(meta.end);
  const span=endM-startM||1;
  const step=30;
  for(let t=startM;t<=endM;t+=step){
    const y=(t-startM)/span*h; addTick(t,y,t%60===0);
  }
  if((endM-startM)%step!==0) addTick(endM, h, true);

  const now=new Date(); const m=now.getHours()*60+now.getMinutes();
  if(m>=startM && m<=endM){
    const y=(m-startM)/span*h; const mark=document.createElement('div');mark.className='nowMarker';mark.style.top=y+'px'; tl.appendChild(mark);
  }
  function addTick(totalMins,y,bold=false){
    const tick=document.createElement('div');tick.className='tl-tick'+(bold?' bold':'');tick.style.top=y+'px';
    const lbl=document.createElement('div');lbl.className='tl-label';lbl.textContent=`${pad(Math.floor(totalMins/60))}:${pad(totalMins%60)}`;
    lbl.style.top='-6px';tick.appendChild(lbl);tl.appendChild(tick);
  }
}

/* =================== SELECT / DELETE / NUMBERING =================== */
function rowSelectToggle(e){
  if(!(e.ctrlKey||e.metaKey)) return;
  e.currentTarget.classList.toggle('selected');showDeleteBtns();
}
function setSelected(row,on){
  document.querySelectorAll('.row.selected').forEach(r=>r.classList.remove('selected'));
  if(on) row.classList.add('selected'); showDeleteBtns();
}
function showDeleteBtns(){
  const any=document.querySelector('.row.selected');
  const flatDel=document.getElementById('flatDelSel');
  if(flatDel) flatDel.style.display=any&&flatMode?'inline-block':'none';
}
function deleteSelected(){
  document.querySelectorAll('.row.selected').forEach(r=>r.remove());
  showDeleteBtns();renumber();scheduleAutoCompute(120,false);scheduleTimelineBuild();
}
document.addEventListener('keydown',e=>{
  if((e.key==='Delete'||e.key==='Backspace')&&document.querySelector('.row.selected')){
    e.preventDefault();deleteSelected();
  }
});
document.addEventListener('click',e=>{
  if(e.ctrlKey||e.metaKey) return;
  if(!document.querySelector('.row.selected')) return;
  const inRow = e.target.closest('.row');
  const onDel = e.target.closest('#flatDelSel');
  if(inRow || onDel) return;
  document.querySelectorAll('.row.selected').forEach(r=>r.classList.remove('selected'));
  showDeleteBtns();
}, true);

function idxToLabel(i){let s='',n=i+1;while(n>0){const r=(n-1)%26;s=String.fromCharCode(65+r)+s;n=Math.floor((n-1)/26);}return s;}
function renumber(){
  if(flatMode){
    const rows=[...document.querySelectorAll('#addrList .row')];
    rows.forEach((r,i)=>{
      const b=r.querySelector('.bullet'); b.textContent=idxToLabel(i);
      b.className='bullet '+(['A','B','C','D','E','F','G','H'][i%8]||'defaultBullet');
    });
    return;
  }
  let i=0;
  FRAMES.forEach(fr=>{
    const sec=document.querySelector(`.frame[data-frame="${fr.id}"]`);
    const vis=(fr.shift==='day'&&dayVisible)||(fr.shift==='night'&&nightVisible);
    if(!vis || sec.classList.contains('collapsed') || sec.style.display==='none') return;
    const rows=[...document.getElementById('frame-'+fr.id).querySelectorAll('.row')];
    rows.forEach(r=>{
      const b=r.querySelector('.bullet'); b.textContent=idxToLabel(i);
      b.className='bullet '+(['A','B','C','D','E','F','G','H'][i%8]||'defaultBullet');
      i++;
    });
  });
}

/* =================== INPUT / AUTOCOMPLETE =================== */
function attachInputEvents(inp){
  inp.addEventListener('mousedown',ev=>{
    if(document.activeElement!==inp){ ev.preventDefault(); safeFocus(inp); setTimeout(()=>inp.select(),0); }
  });
  inp.addEventListener('focus', e=>{
    inp.closest('.row').classList.add('focused');
    setTimeout(()=>e.target.select(),0);
    if(!inp.dataset.lat && (inp.value||'').trim().length>=3){
      fetchPredictions(inp.value, preds => SG.openFor(inp, preds));
    }
  });
  inp.addEventListener('blur',()=>{
    inp.closest('.row').classList.remove('focused');
    setTimeout(()=>{ if(document.activeElement!==inp) SG.hide(); }, 150);
  });
  inp.addEventListener('input',()=>{
    inp.dataset.dirty='1'; inp.dataset.lat=''; inp.dataset.lng='';
    scheduleAutoCompute(200,false);
    if((inp.value||'').trim().length>=3){
      fetchPredictions(inp.value, preds => SG.openFor(inp, preds));
    }else{
      SG.hide();
    }
  });

  inp.addEventListener('keydown', e=>{
    if(!SG.isOpen()) return;
    if(e.key==='ArrowDown'){ e.preventDefault(); SG.move(+1); }
    if(e.key==='ArrowUp'){   e.preventDefault(); SG.move(-1); }
  });

  inp.addEventListener('keydown', e => {
    const isAdvanceKey = (e.key === 'Enter') || (e.key === 'Tab' && !e.shiftKey);
    if (!isAdvanceKey) return;

    e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
    forceCloseAutocomplete(inp);

    if(SG.isOpen() && e.key==='Enter'){ SG.chooseHot(); return; }

    if (flatMode) { focusNextInFlatOrCreate(inp, true); }
    else          { focusNextInFrameOrCreate(inp, true); }

    acceptTopPrediction(inp, { advance:false });
    SG.hide();
    scheduleAutoCompute(150, true);
  });

  inp.addEventListener('paste',multiPaste);
}

/* ---------- Focus helpers ---------- */
function focusNextInFrameOrCreate(currentInput, queueOnly=false){
  const currentRow = currentInput.closest('.row');
  const frameId    = +currentRow.dataset.frame;
  const list       = document.getElementById('frame-'+frameId);
  const rows       = [...list.querySelectorAll('.row')];
  const idx        = rows.indexOf(currentRow);

  const firstEmptyAfter = rows.slice(idx+1).find(r => !r.querySelector('.stop').value.trim());
  let target;
  if(firstEmptyAfter){
    target = firstEmptyAfter.querySelector('.stop');
  }else{
    if(rows[idx+1]){
      const newRow = insertRowAfter(currentRow);
      target = newRow.querySelector('.stop');
    }else{
      const added = addRowToFrame(frameId, false, false);
      target = added.querySelector('.stop');
    }
  }
  if(queueOnly) setTimeout(()=>safeFocus(target),0); else safeFocus(target);
}
function focusNextInFlatOrCreate(currentInput, queueOnly=false){
  const currentRow = currentInput.closest('.row');
  const list       = document.getElementById('addrList');
  const rows       = [...list.querySelectorAll('.row')];
  const idx        = rows.indexOf(currentRow);

  const firstEmptyAfter = rows.slice(idx+1).find(r => !r.querySelector('.stop').value.trim());
  let target;
  if(firstEmptyAfter){
    target = firstEmptyAfter.querySelector('.stop');
  }else{
    const newRow = makeRow(0);
    list.appendChild(newRow);
    renumber();
    target = newRow.querySelector('.stop');
  }
  if(queueOnly) setTimeout(()=>safeFocus(target),0); else safeFocus(target);
}

/* =================== MULTIâ€‘PASTE =================== */
async function multiPaste(e){
  const clip=(e.clipboardData||window.clipboardData).getData('text');
  const lines=clip.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  if(lines.length<=1) return;
  e.preventDefault();
  SG.hide();

  const startRow=e.target.closest('.row');

  /* ---- Flat view ---- */
  if(flatMode){
    const list=document.getElementById('addrList');
    let rows=[...list.querySelectorAll('.row')];
    const startIdx=rows.indexOf(startRow);

    const need=Math.max(0,startIdx+lines.length-rows.length);
    for(let i=0;i<need;i++){ list.appendChild(makeRow(0)); }
    rows=[...list.querySelectorAll('.row')];

    lines.forEach((addr,i)=>{
      const r=rows[startIdx+i]; if(!r) return;
      const el=r.querySelector('.stop');
      el.value=addr; el.dataset.lat=''; el.dataset.lng=''; el.dataset.dirty='1';
    });

    renumber();
    autoResolveNext=true;
    await ensureCoords(lines.map((_,i)=>rows[startIdx+i]).filter(Boolean),{parallel:true});
    await rebuildRoute();
    return;
  }

  /* ---- Day/Night frames ---- */
  const firstFrameId=+startRow.dataset.frame;
  const frMeta=FRAMES.find(f=>f.id===firstFrameId);
  const shift=frMeta.shift;
  const framesInShift = FRAMES.filter(f=>f.shift===shift);
  const startIndexInShift = framesInShift.findIndex(f=>f.id===firstFrameId);

  const targets=[];
  for(let k=startIndexInShift; k<framesInShift.length && targets.length<lines.length; k++){
    const fid=framesInShift[k].id;
    const list=document.getElementById('frame-'+fid);
    ensurePlaceholdersForFrame(fid);
    const rows=[...list.querySelectorAll('.row')];
    let startAt=0;
    if(fid===firstFrameId) startAt=rows.indexOf(startRow);
    for(let i=startAt;i<rows.length && targets.length<lines.length;i++){
      const inp=rows[i].querySelector('.stop');
      if(!inp.value.trim()) targets.push(inp);
    }
    while(targets.length<lines.length && k===framesInShift.length-1){
      const added=addRowToFrame(fid,false,false);
      targets.push(added.querySelector('.stop'));
    }
  }

  for(let i=0;i<lines.length && i<targets.length;i++){
    const inp=targets[i];
    inp.value=lines[i]; inp.dataset.lat=''; inp.dataset.lng=''; inp.dataset.dirty='1';
  }

  renumber();
  autoResolveNext=true;
  await ensureCoords(getOrderedRows(true),{parallel:true});
  await rebuildRoute();
}

/* Accept top prediction on Tab/Enter */
function acceptTopPrediction(input, { advance = true } = {}){
  if (input.dataset.lat && input.dataset.lng){
    delete input.dataset.dirty;
    if (advance){
      if (flatMode) { focusNextInFlatOrCreate(input); }
      else          { focusNextInFrameOrCreate(input); }
    }
    scheduleAutoCompute(0, true);
    return;
  }

  acService.getPlacePredictions(
    { input: input.value, componentRestrictions:{country:'ca'}, types:['address'], locationBias: OK_BOUNDS },
    (preds, status) => {
      if (status !== google.maps.places.PlacesServiceStatus.OK || !preds?.length){
        if (advance){
          if (flatMode) { focusNextInFlatOrCreate(input); }
          else          { focusNextInFrameOrCreate(input); }
        }
        scheduleAutoCompute(0, false);
        return;
      }
      placeSvc.getDetails({ placeId: preds[0].place_id, fields: ['formatted_address','geometry'] },
        (place, st) => {
          if (st === google.maps.places.PlacesServiceStatus.OK && place?.geometry){
            input.value       = place.formatted_address || input.value;
            input.dataset.lat = place.geometry.location.lat();
            input.dataset.lng = place.geometry.location.lng();
            delete input.dataset.dirty;
          }
          if (advance){
            if (flatMode) { focusNextInFlatOrCreate(input); }
            else          { focusNextInFrameOrCreate(input); }
          }
          scheduleAutoCompute(0, true);
        }
      );
    }
  );
}

/* =================== SHIFT / FLAT =================== */
function updateToggleChips(){
  const d=document.getElementById('toggleDay');   if(d) d.classList.toggle('active',dayVisible);
  const n=document.getElementById('toggleNight'); if(n) n.classList.toggle('active',nightVisible);
}

function enforcePanelVisibility(){
  const svOn = map && map.getStreetView().getVisible();
  const panel = document.getElementById('panel');
  const addr  = document.getElementById('addrBar');

  if(svOn){
    panel.style.display = 'none';
    addr.style.display  = 'none';
    return;
  }
  panel.style.display = '';
  if(flatMode){
    panel.classList.add('flat');
    addr.classList.add('active');
    addr.style.display='block';
  }else{
    panel.classList.remove('flat');
    addr.classList.remove('active');
    addr.style.display='none';
  }
}

function toggleShift(which){
  if(which==='day') dayVisible=!dayVisible;
  if(which==='night') nightVisible=!nightVisible;
  applyShiftVisibility();
}
function applyShiftVisibility(){
  const wantFlat = !dayVisible && !nightVisible;
  if (wantFlat) enterFlatMode(); else exitFlatMode();

  FRAMES.forEach(fr=>{
    const sec = document.querySelector(`.frame[data-frame="${fr.id}"]`);
    const vis = (fr.shift==='day' && dayVisible) || (fr.shift==='night' && nightVisible);
    sec.style.display = vis ? 'block' : 'none';
    if (vis && !sec.classList.contains('collapsed')) {
      ensurePlaceholdersForFrame(fr.id, { force:true });
    }
  });

  updateToggleChips();
  rebalanceFrameHeights();
  scheduleTimelineBuild();
  renumber();
  SG.hide();
  hideAllAutocompleteUIs();
  scheduleAutoCompute(120,false);

  enforcePanelVisibility();
}

function buildAddrBar(){
  Sortable.create(document.getElementById('addrList'),{
    handle:'.drag',animation:150, onEnd:()=>{renumber();scheduleAutoCompute(120,false);}
  });
  document.getElementById('toggleDay').onclick=()=>toggleShift('day');
  document.getElementById('toggleNight').onclick=()=>toggleShift('night');
}
function addRowToAddrBar(focus=true,select=false){
  const list=document.getElementById('addrList');
  const row=makeRow(0);list.appendChild(row);renumber();
  if(select) setSelected(row,true);
  if(focus) safeFocus(row.querySelector('.stop'));
  return row;
}
function focusFirstFlatInputIfNone(){
  if(document.activeElement && document.activeElement.classList.contains('stop')) return;
  const list=document.getElementById('addrList');
  const firstEmpty=[...list.querySelectorAll('.stop')].find(i=>!i.value.trim()) || list.querySelector('.stop');
  if(firstEmpty) safeFocus(firstEmpty);
}
function enterFlatMode(){
  if(flatMode) return; flatMode=true;
  clearDirections(); clearLegDisplays();
  SG.hide();
  enforcePanelVisibility();

  const list=document.getElementById('addrList');
  if(list.querySelectorAll('.row').length===0){
    addRowToAddrBar(true,false);
    for(let i=1;i<INITIAL_FLAT_ROWS;i++) addRowToAddrBar(false,false);
  }else{ focusFirstFlatInputIfNone(); }
}
function exitFlatMode(){
  if(!flatMode) return; flatMode=false;
  SG.hide();
  enforcePanelVisibility();
}

/* =================== CLEAR =================== */
function clearAllStops(){
  document.querySelectorAll('.row').forEach(row=>{
    const inp=row.querySelector('.stop');
    row.classList.remove('invalid','selected','focused');
    if(inp){inp.value='';inp.dataset.lat='';inp.dataset.lng='';inp.placeholder='Enter stop'; delete inp.dataset.dirty;}
  });
  frameInitialized.clear();
  clearPreviewPins();clearDirections();clearLegDisplays();
  document.getElementById('msg').textContent='';
  const fm=document.getElementById('flatMsg'); if(fm) fm.textContent='';
  showDeleteBtns(); scheduleTimelineBuild(); renumber();
  SG.hide();
}

/* =================== ROUTING / OPTIMIZATION =================== */
const scheduleAutoCompute=(ms=120, allowResolve=false)=>{
  clearTimeout(autoTimer);
  autoResolveNext = allowResolve;
  autoTimer=setTimeout(()=>autoCompute(),ms);
};

const TEARDROP_PATH = "M0,-28 C-8,-28 -14,-22 -14,-14 c0,11 14,28 14,28 s14,-17 14,-28 C14,-22 8,-28 0,-28 z";

function clearDirections(){dirRend.set('directions',null);dirRend.setMap(null);dirRend.setMap(map);clearRouteMarkers();}
function addPreviewPin(latlng,label){
  const marker=new google.maps.Marker({
    position:latlng,map,
    label:{text:label,color:'#fff',fontSize:'16px',fontWeight:'700'},
    icon:{path:TEARDROP_PATH,scale:1,fillColor:'#4285F4',fillOpacity:1,strokeWeight:1.5,strokeColor:'#263238',labelOrigin:new google.maps.Point(0,-16),anchor:new google.maps.Point(0,0)}
  });
  previewPins.push(marker);
}
function clearPreviewPins(){previewPins.forEach(m=>m.setMap(null));previewPins=[];}

function drawRouteMarkers(points,rows){
  points.forEach((p,i)=>{
    if(!p) return;
    const b=rows[i]?.querySelector('.bullet'); const letter=b?(b.textContent||'').trim():'';
    const classLetter=b?[...b.classList].find(c=>/^[A-Z]$/.test(c)):null;
    const varName=classLetter?`--clr${classLetter}`:'--clrDefault';
    const color=getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
    const marker=new google.maps.Marker({
      position:p,map,
      label:{text:letter,color:'#fff',fontSize:'16px',fontWeight:'700'},
      icon:{path:TEARDROP_PATH,scale:1,fillColor:color||'#607d8b',fillOpacity:1,strokeWeight:1.5,strokeColor:'#263238',labelOrigin:new google.maps.Point(0,-16),anchor:new google.maps.Point(0,0)}
    });
    routeMarkers.push(marker);
  });
}
function clearRouteMarkers(){routeMarkers.forEach(m=>m.setMap(null));routeMarkers=[];}

/* Resolve stack */
async function resolveAddress(text){
  const prediction = await new Promise(res=>{
    acService.getPlacePredictions(
      {input:text, componentRestrictions:{country:'ca'}, types:['address'], locationBias:OK_BOUNDS},
      (preds,status)=>{ if(status===google.maps.places.PlacesServiceStatus.OK && preds?.length) res(preds[0]); else res(null); }
    );
  });
  if(prediction){
    const place = await new Promise(res=>{
      placeSvc.getDetails({placeId:prediction.place_id, fields:['formatted_address','geometry']},
        (p,st)=>res(st===google.maps.places.PlacesServiceStatus.OK?p:null));
    });
    if(place?.geometry && OK_BOUNDS.contains(place.geometry.location)){
      return {lat:place.geometry.location.lat(),lng:place.geometry.location.lng(),formatted:place.formatted_address};
    }
  }
  return await geocodeSmart(text);
}
function geocodeSmart(addr,attempt=0){
  return new Promise(res=>{
    geocoder.geocode({address:addr,componentRestrictions:{country:'CA'},bounds:OK_BOUNDS,region:'CA'},
      (results,status)=>{
        if(status==='OK'&&results[0]){
          const loc=results[0].geometry.location;
          if(!OK_BOUNDS.contains(loc)){ res(null); }
          else res({lat:loc.lat(),lng:loc.lng(),formatted:results[0].formatted_address});
        }else if(status==='OVER_QUERY_LIMIT' && attempt<5){
          setTimeout(()=>geocodeSmart(addr,attempt+1).then(res), 250*(attempt+1));
        }else res(null);
      });
  });
}
async function ensureCoords(rows,{parallel=false}={}){
  const tasks = rows.map(row=>async ()=>{
    const inp=row.querySelector('.stop');
    row.classList.remove('invalid');
    if(!inp.value) return true;
    if(inp.dataset.lat && inp.dataset.lng) return true;
    const out = await resolveAddress(inp.value);
    if(out){ inp.dataset.lat=out.lat; inp.dataset.lng=out.lng; inp.value=out.formatted; delete inp.dataset.dirty; return true; }
    row.classList.add('invalid'); inp.placeholder='Unrecognised â€“ edit me'; return false;
  });

  if(!parallel){
    for(const t of tasks){ const ok=await t(); if(!ok) return false; }
    return true;
  }else{
    const CONC=4; let i=0, okAll=true;
    await Promise.all(Array.from({length:CONC},async ()=>{
      while(i<tasks.length){ const my=i++; const ok=await tasks[my](); if(!ok) okAll=false; }
    }));
    return okAll;
  }
}

function getOrderedRows(includeHidden=false){
  if(flatMode) return [...document.querySelectorAll('#addrList .row')].filter(r=>r.querySelector('.stop').value.trim());
  const rows=[];
  FRAMES.forEach(f=>{
    const sec=document.querySelector(`.frame[data-frame="${f.id}"]`);
    const vis=(f.shift==='day'&&dayVisible)||(f.shift==='night'&&nightVisible)||includeHidden;
    if(!vis) return;
    if(sec.classList.contains('collapsed') && !includeHidden) return;
    rows.push(...document.getElementById('frame-'+f.id).querySelectorAll('.row'));
  });
  return rows.filter(r=>r.querySelector('.stop').value.trim());
}

/* Main autoCompute */
async function autoCompute(){
  const rows=getOrderedRows();
  const msg=document.getElementById('msg'), flatMsg=document.getElementById('flatMsg');

  if(rows.filter(r=>r.querySelector('.stop').value.trim()).length===0){
    clearPreviewPins();clearLegDisplays();msg.textContent=''; if(flatMsg) flatMsg.textContent=''; clearDirections();return;
  }

  if(rows.some(r=>!r.querySelector('.stop').dataset.lat)){
    if(autoResolveNext){ await ensureCoords(rows,{parallel:true}); autoResolveNext=false; }
    else{ clearDirections(); clearLegDisplays(); return; }
  }

  if(rows.length===1){
    clearDirections();clearLegDisplays();clearPreviewPins();
    const inp=rows[0].querySelector('.stop');
    addPreviewPin({lat:+inp.dataset.lat,lng:+inp.dataset.lng},'A');
    msg.textContent=''; if(flatMsg) flatMsg.textContent='';
  }else{
    clearPreviewPins(); await rebuildRoute();
  }
}

/* Rebuild directions on map */
async function rebuildRoute(){
  const rows=getOrderedRows();
  const msg=document.getElementById('msg'), flatMsg=document.getElementById('flatMsg');
  clearLegDisplays();clearRouteMarkers();
  if(rows.length<2){msg.textContent=''; if(flatMsg) flatMsg.textContent=''; clearDirections();return;}
  const ok=await ensureCoords(rows,{parallel:true});
  if(!ok){msg.textContent='One or more stops canâ€™t be located â€“ please edit.'; if(flatMsg) flatMsg.textContent=msg.textContent;return;}
  const locs=rows.map(r=>({lat:+r.querySelector('.stop').dataset.lat,lng:+r.querySelector('.stop').dataset.lng}));
  return new Promise(resolve=>{
    dirSvc.route({
      origin:locs[0],destination:locs[locs.length-1],
      waypoints:locs.slice(1,-1).map(l=>({location:l,stopover:true})),
      travelMode:'DRIVING'
    },(res,stat)=>{
      displayLegs(res,stat);
      if(stat==='OK'){
        const pts=[locs[0],...locs.slice(1,-1),locs[locs.length-1]];
        drawRouteMarkers(pts,rows);
      }
      resolve();
    });
  });
}

/* Leg summaries */
function displayLegs(res,stat){
  const msg=document.getElementById('msg'), flatMsg=document.getElementById('flatMsg');
  if(stat!=='OK'){msg.textContent='Route error: '+stat; if(flatMsg) flatMsg.textContent=msg.textContent; clearDirections();return;}
  dirRend.setDirections(res);
  const rows=getOrderedRows();
  let kmTot=0,minTot=0;clearLegDisplays();
  res.routes[0].legs.forEach((leg,i)=>{
    const km=leg.distance.value/1000,min=Math.round(leg.duration.value/60);
    kmTot+=km;minTot+=min;
    const startLetter=rows[i]?.querySelector('.bullet')?.textContent.trim()||'';
    const cls=['A','B','C','D','E','F','G','H'].includes(startLetter)?('leg-'+startLetter):'leg-default';
    const div=document.createElement('div');div.className='leg-display '+cls;
    div.textContent=`Distance ${km.toFixed(1)} km | â‰ˆ ${min} min`;
    rows[i].after(div);
  });
  const text=`Total Distance ${kmTot.toFixed(1)} km | â‰ˆ ${minTot} min`;
  msg.textContent=text; if(flatMsg) flatMsg.textContent=text;
}
function clearLegDisplays(){document.querySelectorAll('.leg-display').forEach(d=>d.remove());}

/* =================== TSP helpers =================== */
function buildDistanceMatrix(points){const n=points.length;const D=Array.from({length:n},()=>Array(n).fill(0));for(let i=0;i<n;i++){for(let j=i+1;j<n;j++){const d=haversine(points[i],points[j]);D[i][j]=D[j][i]=d;} }return D;}
function haversine(a,b){const R=6371;const toRad=x=>x*Math.PI/180;const dLat=toRad(b.lat-a.lat);const dLng=toRad(b.lng-a.lng);const s=Math.sin(dLat/2)**2+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;return 2*R*Math.asin(Math.sqrt(s));}
function orderCost(order,D){let c=0; for(let i=0;i<order.length-1;i++) c+=D[order[i]][order[i+1]]; return c;}
function nearestNeighbour(D,start=0){const n=D.length; const visited=Array(n).fill(false); const ord=[start]; visited[start]=true; for(let k=1;k<n;k++){const last=ord[ord.length-1]; let best=Infinity,idx=-1; for(let j=0;j<n;j++){ if(!visited[j] && D[last][j]<best){best=D[last][j]; idx=j;} } ord.push(idx); visited[idx]=true;} return ord;}
function twoOpt(order,D){const n=order.length; let improved=true; while(improved){improved=false; for(let i=1;i<n-2;i++){for(let j=i+1;j<n-1;j++){const a=order[i-1],b=order[i],c=order[j],d=order[j+1]; if(D[a][b]+D[c][d] > D[a][c]+D[b][d]){ order.splice(i,j-i+1,...order.slice(i,j+1).reverse()); improved=true; }}}} return order;}
function solveTSPWithMatrix(D,{fixedStart=null,fixedEnd=null}={}){const n=D.length; let start=fixedStart!=null?fixedStart:0; let ord=nearestNeighbour(D,start); ord=twoOpt(ord,D); if(fixedEnd!=null && ord[ord.length-1]!==fixedEnd){let best=ord,bestCost=orderCost(ord,D); for(let s=0;s<n;s++){const r=[...ord.slice(s),...ord.slice(0,s)]; if(r[r.length-1]!==fixedEnd) continue; const c=orderCost(r,D); if(c<bestCost){best=r; bestCost=c;}} ord=best;} if(fixedStart!=null && ord[0]!==fixedStart){const idx=ord.indexOf(fixedStart); if(idx>-1) ord=[...ord.slice(idx),...ord.slice(0,idx)];} return ord;}

/* -------- Optimize by Frames (F4) -------- */
async function optimizeByFramesTwoPass(){
  if (flatMode) return;  // Only for Day/Night view
  clearLegDisplays(); // avoid duplicate leg lines during reorder

  const dist = (a,b)=>{
    if(!a||!b) return 0;
    const R=6371, toRad=x=>x*Math.PI/180;
    const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
    const s=Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
    return 2*R*Math.asin(Math.sqrt(s));
  };

  const frames = FRAMES.filter(fr=>{
    const sec = document.querySelector(`.frame[data-frame="${fr.id}"]`);
    return ((fr.shift==='day'&&dayVisible)||(fr.shift==='night'&&nightVisible)) &&
           !sec.classList.contains('collapsed') &&
           sec.style.display!=='none';
  });
  if(!frames.length) return;

  const perFrameOptions = [];

  for (const fr of frames){
    const list   = document.getElementById('frame-'+fr.id);
    const rows   = [...list.querySelectorAll('.row')];
    const filled = rows.filter(r=>r.querySelector('.stop').value.trim());

    if (filled.length <= 1){
      const only = filled[0] || null;
      const pt   = only ? {lat:+only.querySelector('.stop').dataset.lat, lng:+only.querySelector('.stop').dataset.lng} : null;
      perFrameOptions.push([{ internalCost: 0, startPt: pt, endPt: pt, sequenceRows: only ? [only] : [] }]);
      continue;
    }

    const ok = await ensureCoords(filled, {parallel:true});
    if(!ok){
      const ptsNow = filled.map(r=>({lat:+r.querySelector('.stop').dataset.lat,lng:+r.querySelector('.stop').dataset.lng}));
      perFrameOptions.push([{ internalCost: 0, startPt: ptsNow[0], endPt: ptsNow[ptsNow.length-1], sequenceRows: filled }]);
      continue;
    }

    const pts = filled.map(r=>({lat:+r.querySelector('.stop').dataset.lat,lng:+r.querySelector('.stop').dataset.lng}));
    const D   = buildDistanceMatrix(pts);

    let tour = nearestNeighbour(D, 0);
    tour = twoOpt(tour, D);

    let tourCost = 0;
    for(let i=0;i<tour.length-1;i++) tourCost += D[tour[i]][tour[i+1]];
    tourCost += D[tour[tour.length-1]][tour[0]];

    const options = [];
    const m = tour.length;

    for(let cut=0; cut<m; cut++){
      const a = tour[cut], b = tour[(cut+1)%m];
      const internalCost = tourCost - D[a][b];

      const forwardIdx=[]; for(let t=0;t<m;t++) forwardIdx.push( tour[(cut+1+t)%m] );
      const seqRowsF = forwardIdx.map(i=>filled[i]); const startPtF = pts[b], endPtF = pts[a];

      const backIdx  = [...forwardIdx].reverse();
      const seqRowsB = backIdx.map(i=>filled[i]); const startPtB = pts[a], endPtB = pts[b];

      options.push({ internalCost, startPt:startPtF, endPt:endPtF, sequenceRows:seqRowsF });
      options.push({ internalCost, startPt:startPtB, endPt:endPtB, sequenceRows:seqRowsB });
    }
    perFrameOptions.push(options);
  }

  const N = perFrameOptions.length;
  const dp  = perFrameOptions.map(opts => new Array(opts.length).fill(Infinity));
  const prv = perFrameOptions.map(opts => new Array(opts.length).fill(-1));

  perFrameOptions[0].forEach((opt,k)=>{ dp[0][k]=opt.internalCost; });

  for(let i=1;i<N;i++){
    perFrameOptions[i].forEach((optK,k)=>{
      let bestCost = Infinity, bestJ = -1;
      perFrameOptions[i-1].forEach((optJ,j)=>{
        const link = dist(optJ.endPt, optK.startPt);
        const cand = dp[i-1][j] + link + optK.internalCost;
        if(cand < bestCost){ bestCost=cand; bestJ=j; }
      });
      dp[i][k] = bestCost; prv[i][k] = bestJ;
    });
  }

  let lastK = dp[N-1].reduce((bestIdx, v, idx)=> v < dp[N-1][bestIdx] ? idx : bestIdx, 0);
  const chosen = new Array(N);
  for(let i=N-1;i>=0;i--){ chosen[i]=lastK; lastK = i>0 ? prv[i][lastK] : -1; }

  frames.forEach((fr, i)=>{
    const list = document.getElementById('frame-'+fr.id);
    const opt  = perFrameOptions[i][ chosen[i] ];
    opt.sequenceRows.forEach(r=>list.appendChild(r));
    // remove empties after optimizing
    [...list.querySelectorAll('.row')].forEach(r=>{
      if(!r.querySelector('.stop').value.trim()) r.remove();
    });
  });

  renumber();
  scheduleAutoCompute(0,true);
}

/* =================== INIT =================== */
window.routePlannerInit=()=>{
  map=new google.maps.Map(document.getElementById('map'),{
    center:{lat:49.8879,lng:-119.4960}, zoom:10,
    mapTypeControl:false,streetViewControl:true,fullscreenControl:true,tilt:0
  });

  OK_BOUNDS = new google.maps.LatLngBounds(
    new google.maps.LatLng(49.60,-119.80),
    new google.maps.LatLng(50.20,-119.15)
  );

  /* ---------- Region overlay + KML ---------- */
  function nameToAccent(name){
    if(LABEL_COLOR_MODE==='uniform') return getComputedStyle(document.documentElement).getPropertyValue('--label-accent').trim()||'#5b46ff';
    let h=0; for(let i=0;i<name.length;i++){ h=(h*31 + name.charCodeAt(i)) % 360; }
    return `hsl(${h} 75% 70%)`;
  }

  class RegionLabelOverlay extends google.maps.OverlayView{
    constructor(pos,text,accent){
      super(); this.position=pos; this.text=text||''; this.accent=accent||'#9ecfff'; this.container=null;
    }
    onAdd(){
      const div=document.createElement('div');
      div.className='region-label';
      div.style.setProperty('--accent', this.accent);
      div.innerHTML=
        `<div class="region-card">
           <div class="region-accent"></div>
           <div class="region-title">${this.text}</div>
           <span class="region-close material-icons" title="Close">close</span>
         </div>`;
      div.querySelector('.region-close').onclick=()=>this.setMap(null);
      this.container=div;
      this.getPanes().floatPane.appendChild(div);
      requestAnimationFrame(()=>div.classList.add('show'));
    }
    draw(){
      const proj=this.getProjection(); if(!proj||!this.container) return;
      const pt=proj.fromLatLngToDivPixel(this.position);
      this.container.style.left=pt.x+'px';
      this.container.style.top =pt.y+'px';
    }
    onRemove(){
      if(!this.container) return;
      const el=this.container;
      el.classList.remove('show');
      el.classList.add('leaving');
      setTimeout(()=>{ if(el&&el.parentNode) el.parentNode.removeChild(el); }, 115);
      this.container=null;
    }
  }

  let currentRegionOverlay=null;
  let currentRegionId=null;
  function showRegionLabel(pos,name,id){
    hideRegionLabel();
    currentRegionOverlay=new RegionLabelOverlay(pos,name,nameToAccent(name));
    currentRegionId=id || name || '';
    currentRegionOverlay.setMap(map);
  }
  function hideRegionLabel(){
    if(currentRegionOverlay){ currentRegionOverlay.setMap(null); }
    currentRegionOverlay=null; currentRegionId=null;
  }

  const kml=new google.maps.KmlLayer({
    url:'https://circuitsagexy.github.io/okanagan-map/r5a1LjX92e-djkvc12df/okanagan.kmz',
    map, preserveViewport:true, suppressInfoWindows:true, screenOverlays:false, clickable:true, zIndex:0
  });
  kml.addListener('click', (e)=>{
    const name=e.featureData?.name||'';
    const id  = e.featureData?.id || name;
    if(currentRegionOverlay && currentRegionId===id){ hideRegionLabel(); return; }
    const pos=e.latLng || e.featureData?.position || map.getCenter();
    showRegionLabel(pos, name, id);
  });
  map.addListener('click', hideRegionLabel);
  document.getElementById('panel').addEventListener('click', hideRegionLabel, true);

  /* ---------- Services ---------- */
  dirSvc=new google.maps.DirectionsService();
  dirRend=new google.maps.DirectionsRenderer({map,suppressMarkers:true});
  geocoder=new google.maps.Geocoder();
  acService=new google.maps.places.AutocompleteService();
  placeSvc=new google.maps.places.PlacesService(map);

  buildFrameBuckets();
  buildAddrBar();

  // Default = FLAT view
  applyShiftVisibility();

  // Flat Optimize removes empties first, then optimizes
  document.getElementById('flatOpt').onclick=()=>{autoResolveNext=true; globalOptimizeRoute();};
  document.getElementById('flatDelSel').onclick=deleteSelected;

  // Street View: hide/show panels automatically
  const sv = map.getStreetView();
  sv.addListener('visible_changed', () => enforcePanelVisibility());
  enforcePanelVisibility();

  /* ---------- Robust Visualâ€‘Search / Lens hider ---------- */
  (function robustHideLens(){
    const CSS_TEXT = `
      [aria-label*="Visual"],[title*="Visual"],
      [aria-label*="Lens"],[title*="Lens"],
      .widget-visual-search,.scene-viewcard-button,.app-viewcard-strip{ display:none !important; }`;

    const styleOn = (root)=>{
      try{
        if(!root) return;
        if(root.__lensStyleApplied) return;
        const st=document.createElement('style'); st.textContent=CSS_TEXT;
        root.appendChild(st); root.__lensStyleApplied=true;
      }catch(_){}
    };

    const isTarget = (el)=>{
      try{
        const aria=(el.getAttribute?.('aria-label')||'').toLowerCase();
        const title=(el.getAttribute?.('title')||'').toLowerCase();
        const txt=(el.textContent||'').toLowerCase();
        return (aria.includes('visual')||aria.includes('lens')||
                title.includes('visual')||title.includes('lens')||
                txt.includes('visual search'));
      }catch(_){return false;}
    };

    const hideNode = (el)=>{
      try{
        let target=el;
        const host = el.closest('[role="toolbar"],[class*="strip"],[class*="control"],[class*="viewcard"],[class*="immersive"],[jslog]');
        if(host) target=host;
        target.style.display='none'; target.hidden=true; target.setAttribute('aria-hidden','true');
      }catch(_){}
    };

    const walk = (node)=>{
      if(!node) return;
      const S = [node];
      while(S.length){
        const n=S.pop();
        if(!n) continue;
        if(n instanceof ShadowRoot){ styleOn(n); Array.from(n.children).forEach(ch=>S.push(ch)); continue; }
        if(n.nodeType===1){
          const el=n;
          if(el.shadowRoot){ styleOn(el.shadowRoot); S.push(el.shadowRoot); }
          if(isTarget(el)) hideNode(el);
          Array.from(el.children).forEach(ch=>S.push(ch));
        }
      }
    };

    const run = ()=>walk(document.body);
    run();
    const mo = new MutationObserver(()=>run());
    mo.observe(document.body, {subtree:true, childList:true, attributes:true});

    // also try on typical map state changes
    ['idle','dragend','zoom_changed'].forEach(evt=>map.addListener(evt, run));
    map.getStreetView().addListener('visible_changed', run);

    // burst a few times during first seconds (when Maps injects controls)
    let burst=0; const id=setInterval(()=>{ run(); if(++burst>12) clearInterval(id); }, 300);
  })();

  (function attachFunctionKeyTrap(){
    function onDown(e){
      if(!['F1','F2','F3','F4'].includes(e.key)) return;
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
      if(e.repeat) return;
      if(e.key==='F1') toggleShift('day');
      else if(e.key==='F2') toggleShift('night');
      else if(e.key==='F3') clearAllStops();
      else if(e.key==='F4'){ if(!flatMode){ autoResolveNext=true; optimizeByFramesTwoPass(); } }
    }
    function onUp(e){
      if(!['F1','F2','F3','F4'].includes(e.key)) return;
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
    }
    window.addEventListener('keydown', onDown, {capture:true, passive:false});
    window.addEventListener('keyup',   onUp,   {capture:true, passive:false});
    document.onhelp = () => false; window.onhelp = () => false;
  })();

  window.addEventListener('resize', ()=>{ clearTimeout(window.__rb); window.__rb=setTimeout(()=>{rebalanceFrameHeights();},150); });

  if(window.__mapsApiReady){ /* maps already loaded */ }
};

/* --------- Flatâ€‘view optimizer (removes empties first) --------- */
async function globalOptimizeRoute(){
  if(!flatMode){ return; }
  const list=document.getElementById('addrList');

  // Remove all empty rows before optimizing
  [...list.querySelectorAll('.row')].forEach(r=>{
    if(!r.querySelector('.stop').value.trim()) r.remove();
  });

  const rows=[...list.querySelectorAll('.row')].filter(r=>r.querySelector('.stop').value.trim());
  if(rows.length<=1){ renumber(); scheduleAutoCompute(0,true); return; }

  const ok=await ensureCoords(rows,{parallel:true});
  if(!ok){ const fm=document.getElementById('flatMsg'); if(fm) fm.textContent='One or more stops canâ€™t be located â€“ please edit.'; return; }

  const pts=rows.map(r=>({lat:+r.querySelector('.stop').dataset.lat,lng:+r.querySelector('.stop').dataset.lng}));
  const D=buildDistanceMatrix(pts);
  const ord=solveTSPWithMatrix(D);
  const ordered=ord.map(i=>rows[i]);
  ordered.forEach(r=>list.appendChild(r));

  renumber();
  scheduleAutoCompute(0,true);
}
</script>
</body>
</html>
