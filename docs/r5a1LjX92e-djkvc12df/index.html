<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Okanagan Route Planner</title>

<!-- Google icons -->
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

<style>
:root{
  /* colour palette */
  --clrA:#4285F4; --clrB:#0F9D58; --clrC:#F4B400; --clrD:#DB4437;
  --clrDefault:#607d8b;
  --clrE:#ab47bc; --clrF:#00acc1; --clrG:#ff7043; --clrH:#8d6e63;

  --clrPanelBg:#ffffff; --clrPanelStripe:#2196f3; --clrPanelBorder:#d7d7d7;
  --clrPanelShadow:0 2px 8px rgba(0,0,0,.25);
  --clrInputBorder:#c7c7c7; --clrInputBg:#fff; --clrInputBgAlt:#fafafa;
  --radiusSm:4px; --radiusMd:6px; --radiusLg:10px;
  --transFast:.12s; --fontMain:Roboto,Arial,sans-serif;
}
html,body,#map{height:100%;margin:0;font-family:var(--fontMain);}

/* Time‑frame column */
#timelineDock{position:absolute;top:0;left:0;width:110px;height:100%;
  border-right:1px solid var(--clrPanelBorder);background:#fff;z-index:6;}
#timelineDock iframe{width:110%;height:100%;border:none;}

#panel{position:absolute;top:0;left:0;z-index:5;width:340px;max-height:100%;
  background:var(--clrPanelBg);
  padding:16px 14px 12px 126px;border-right:1px solid var(--clrPanelBorder);
  box-shadow:var(--clrPanelShadow);overflow:auto;
  border-top-right-radius:var(--radiusLg);border-bottom-right-radius:var(--radiusLg);}
#panel::before{content:"";position:absolute;top:0;left:0;right:0;height:4px;
  background:var(--clrPanelStripe);}

.row{display:flex;align-items:center;margin:12px 0;padding:4px 6px 4px 0;
  border-radius:var(--radiusMd);transition:background var(--transFast),box-shadow var(--transFast);}
.row.focused{background:var(--clrInputBgAlt);box-shadow:0 0 0 2px rgba(33,150,243,.25);}
.row:hover:not(.focused){background:rgba(0,0,0,.04);}
.row.invalid input.stop{border-color:#e53935;background:#ffebee;}

.bullet{width:24px;height:24px;border-radius:50%;line-height:24px;text-align:center;
  font-weight:600;font-size:13px;color:#fff;margin-right:8px;flex:none;
  box-shadow:0 0 0 2px rgba(255,255,255,.8),0 0 4px rgba(0,0,0,.35);}
.A{background:var(--clrA)} .B{background:var(--clrB)} .C{background:var(--clrC)} .D{background:var(--clrD)}
.E{background:var(--clrE)} .F{background:var(--clrF)} .G{background:var(--clrG)} .H{background:var(--clrH)}
.defaultBullet{background:var(--clrDefault)}

input.stop{flex:1;height:38px;border:1px solid var(--clrInputBorder);
  border-radius:var(--radiusSm);padding:4px 6px 4px 10px;font-size:14px;
  background:var(--clrInputBg);transition:border-color var(--transFast),box-shadow var(--transFast);}
input.stop:focus{outline:none;border-color:var(--clrPanelStripe);
  box-shadow:0 0 0 3px rgba(33,150,243,.25);}

/* coloured stripes */
.row .bullet.A + input.stop{border-left:4px solid var(--clrA);padding-left:6px;}
.row .bullet.B + input.stop{border-left:4px solid var(--clrB);padding-left:6px;}
.row .bullet.C + input.stop{border-left:4px solid var(--clrC);padding-left:6px;}
.row .bullet.D + input.stop{border-left:4px solid var(--clrD);padding-left:6px;}
.row .bullet.E + input.stop{border-left:4px solid var(--clrE);padding-left:6px;}
.row .bullet.F + input.stop{border-left:4px solid var(--clrF);padding-left:6px;}
.row .bullet.G + input.stop{border-left:4px solid var(--clrG);padding-left:6px;}
.row .bullet.H + input.stop{border-left:4px solid var(--clrH);padding-left:6px;}
.row .bullet.defaultBullet + input.stop{border-left:4px solid var(--clrDefault);padding-left:6px;}

.drag{cursor:grab;margin-left:6px;color:#666;font-size:22px;line-height:22px;
  padding:2px;border-radius:var(--radiusSm);transition:background var(--transFast);}
.drag:hover{background:rgba(0,0,0,.08);} .drag:active{cursor:grabbing;}

.remove{cursor:pointer;margin-left:4px;font-size:20px;line-height:20px;color:#fff;
  width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center;
  background:var(--clrD);border-radius:var(--radiusSm);
  transition:transform var(--transFast),background var(--transFast);}
.remove:hover{background:#f75a4d;transform:scale(1.08);} .remove:active{transform:scale(.94);}

#add,#route,#opt{margin-top:8px;margin-bottom:14px;padding:8px 14px;font-size:14px;
  border-radius:var(--radiusMd);border:1px solid transparent;cursor:pointer;
  transition:background var(--transFast),box-shadow var(--transFast),transform var(--transFast);}
#add{margin-left:28px;background:#e0e0e0;color:#000;border-color:#d0d0d0;}
#add:hover{background:#e7e7e7;} #add:active{transform:scale(.96);}
#route{margin-left:8px;background:var(--clrA);color:#fff;border-color:var(--clrA);}
#route:hover{background:#5b9bff;} #route:active{transform:scale(.96);}
#opt{margin-left:8px;background:var(--clrB);color:#fff;border-color:var(--clrB);}
#opt:hover{background:#26c36c;} #opt:active{transform:scale(.96);}

.leg-display{margin:6px 0 0 28px;font-size:16px;font-weight:600;color:#1b1b1b;
  padding:4px 10px;border-radius:6px;background:rgba(0,0,0,.06);
  display:inline-block;line-height:1.25;white-space:nowrap;}
.leg-A{background:rgba(66,133,244,.15);border-left:4px solid var(--clrA);}
.leg-B{background:rgba(15,157,88,.18);border-left:4px solid var(--clrB);}
.leg-C{background:rgba(244,180,0,.20);border-left:4px solid var(--clrC);}
.leg-D{background:rgba(219,68,55,.20);border-left:4px solid var(--clrD);}
.leg-E{background:rgba(171,71,188,.18);border-left:4px solid var(--clrE);}
.leg-F{background:rgba(0,172,193,.18);border-left:4px solid var(--clrF);}
.leg-G{background:rgba(255,112,67,.18);border-left:4px solid var(--clrG);}
.leg-H{background:rgba(141,110,99,.18);border-left:4px solid var(--clrH);}
.leg-default{background:rgba(96,125,139,.18);border-left:4px solid var(--clrDefault);}

#msg{margin:12px 0;color:#0066cc;font-weight:700;font-size:17px;padding:4px 0 0 28px;}
</style>

<!-- stub so Google Maps always finds a callback -->
<script>function init(){ if(typeof window.routePlannerInit==='function'){window.routePlannerInit();}else{window.__mapsApiReady=true;} }</script>

<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDnpSCHQWHr1neHALY-xddNne_S7f608co&callback=init&libraries=places,geometry">
</script>

<!-- SortableJS -->
<script type="module" src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/modular/sortable.core.esm.js"></script>
</head>
<body>

<div id="timelineDock"><iframe src="TimeFrames.html" title="TimeFrames" loading="lazy"></iframe></div>

<div id="panel">
  <div id="stops"></div>
  <button id="add">+ Add stop</button>
  <button id="route">Route</button>
  <button id="opt">Optimize</button>
  <div id="msg"></div>
</div>

<div id="map"></div>

<script type="module">
import Sortable from 'https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/+esm';

const labels='ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
const colours=['A','B','C','D','E','F','G','H'];

let map,dirSvc,dirRend,geocoder,acSvc,placeSvc;
let autoTimer=null,routeVer=0,previewPins=[];

/* ────────────────── geometry & validation helpers ────────────────── */
const IHA_POLY=[{lat:53.40,lng:-118.50},{lat:53.50,lng:-122.00},{lat:52.50,lng:-123.00},
 {lat:51.00,lng:-123.00},{lat:50.10,lng:-123.20},{lat:49.80,lng:-122.40},
 {lat:49.00,lng:-120.00},{lat:49.00,lng:-114.00},{lat:51.20,lng:-114.00},
 {lat:53.00,lng:-116.00}];
function insidePoly(pt,poly){let c=false,j=poly.length-1;
  for(let i=0;i<poly.length;i++){const pi=poly[i],pj=poly[j];
    if(((pi.lng>pt.lng)!=(pj.lng>pt.lng)) &&
       pt.lat<(pj.lat-pi.lat)*(pt.lng-pi.lng)/(pj.lng-pi.lng)+pi.lat) c=!c;
    j=i;}return c;}
const CENTRAL_OK_BOUNDS={south:49.60,north:50.30,west:-120.20,east:-118.90};
const CENTRAL_OK_RX=/kelowna|west kelowna|lake country|oyama|peachland|fintry|joe rich|ellison|rutland|glenmore|glenrosa/i;

/* smart geocoder */
const geocodeSmart=txt=>{
  const cleaned=txt.replace(/\s+/g,' ').trim();
  if(!cleaned) return Promise.resolve(null);
  return new Promise(res=>{
    acSvc.getPlacePredictions({
      input:cleaned,bounds:CENTRAL_OK_BOUNDS,
      componentRestrictions:{country:'ca'},types:['address']
    },(preds,s)=>{
      if(s===google.maps.places.PlacesServiceStatus.OK&&preds?.length){
        const pred=preds.find(p=>CENTRAL_OK_RX.test(p.description))||preds[0];
        placeSvc.getDetails({placeId:pred.place_id,fields:['formatted_address','geometry']},
          (plc,s2)=>{
            if(s2===google.maps.places.PlacesServiceStatus.OK&&plc?.geometry){
              const loc=plc.geometry.location;
              return res({lat:loc.lat(),lng:loc.lng(),formatted:plc.formatted_address});
            }
            fallback();
          });
      }else fallback();
    });
    function fallback(){
      geocoder.geocode(
        {address:`${cleaned}, BC, Canada`,componentRestrictions:{country:'ca'}},
        (r,s)=>{
          if(s==='OK'&&r[0]){
            const loc=r[0].geometry.location;
            res({lat:loc.lat(),lng:loc.lng(),formatted:r[0].formatted_address});
          }else res(null);
        });
    }
  });
};

/* batch geocode unresolved rows */
const ensureCoords=rows=>{
  const tasks=rows.map(row=>{
    const inp=row.querySelector('.stop');row.classList.remove('invalid');
    if(!inp.value||(inp.dataset.lat&&inp.dataset.lng))return;
    return geocodeSmart(inp.value).then(out=>{
      if(out){inp.dataset.lat=out.lat;inp.dataset.lng=out.lng;inp.value=out.formatted;}
      else{row.classList.add('invalid');inp.placeholder='Unrecognised – edit me';}
    });
  });
  return Promise.all(tasks);
};

/* ────────────────── DOM helpers ────────────────── */
const makeRow=i=>{
  const d=document.createElement('div');d.className='row';
  const clr=colours[i%colours.length]||'defaultBullet';
  d.innerHTML=`
    <div class="bullet ${clr}">${labels[i]}</div>
    <input class="stop" placeholder="Enter stop">
    <span class="material-icons drag">drag_indicator</span>
    <span class="remove">×</span>`;
  d.querySelector('.remove').onclick=()=>{d.remove();renumber();autoCompute();};
  return d;
};
const renumber=()=>[...document.querySelectorAll('.row')].forEach((r,i)=>{
  const b=r.querySelector('.bullet');
  b.textContent=labels[i]||'?';
  b.className='bullet '+(colours[i%colours.length]||'defaultBullet');
});
const clearPreviewPins=()=>{previewPins.forEach(m=>m.setMap(null));previewPins=[];};
const clearLegDisplays=()=>document.querySelectorAll('.leg-display').forEach(e=>e.remove());

/* fresh renderer (guaranteed blank) */
function reallyClearRoute(){
  if(dirRend){dirRend.setMap(null);}
  dirRend=new google.maps.DirectionsRenderer({map});
}

/* ────────────────── Init ────────────────── */
window.routePlannerInit=()=>{
  /* base map */
  map=new google.maps.Map(document.getElementById('map'),
        {center:{lat:49.8879,lng:-119.4960},zoom:10});
  new google.maps.KmlLayer({
    url:'https://circuitsagexy.github.io/okanagan-map/r5a1LjX92e-djkvc12df/okanagan.kmz',
    map,preserveViewport:true
  });

  dirSvc=new google.maps.DirectionsService();
  dirRend=new google.maps.DirectionsRenderer({map});
  geocoder=new google.maps.Geocoder();
  acSvc=new google.maps.places.AutocompleteService();
  placeSvc=new google.maps.places.PlacesService(map);

  const list=document.getElementById('stops');
  list.appendChild(makeRow(0));list.appendChild(makeRow(1));
  Sortable.create(list,{handle:'.drag',animation:150,onEnd:()=>{renumber();autoCompute();}});

  /* shared autocomplete opts */
  const acOpts={fields:['formatted_address','geometry','place_id'],types:['address'],
    componentRestrictions:{country:'ca'},bounds:CENTRAL_OK_BOUNDS,strictBounds:true};

  const attach=input=>{
    const ph='Enter stop';input.placeholder=ph;
    input.addEventListener('focus',e=>{
      input.closest('.row').classList.add('focused');
      setTimeout(()=>e.target.select(),0);
      const mu=ev=>{ev.preventDefault();input.removeEventListener('mouseup',mu);};
      input.addEventListener('mouseup',mu);
    });
    input.addEventListener('blur',()=>input.closest('.row').classList.remove('focused'));
    input.addEventListener('input',()=>{input.dataset.lat='';input.dataset.lng='';schedule();});
    input.addEventListener('change',schedule);

    /* Tab key -> accept top prediction */
    input.addEventListener('keydown',e=>{
      if(e.key==='Tab'&&!e.shiftKey){
        if(input.dataset.lat&&input.dataset.lng)return;
        e.preventDefault();acceptTopPrediction(input);
      }
    });

    /* Google Places widget */
    const ac=new google.maps.places.Autocomplete(input,acOpts);
    ac.addListener('place_changed',()=>{
      const plc=ac.getPlace();
      if(!plc.geometry){input.value='';return;}
      const loc=plc.geometry.location,pt={lat:loc.lat(),lng:loc.lng()};
      if(!insidePoly(pt,IHA_POLY)){
        input.value='';input.placeholder='Outside Interior Health';
        setTimeout(()=>{if(!input.value)input.placeholder=ph;},3000);return;
      }
      input.value=plc.formatted_address||plc.name;
      input.dataset.lat=pt.lat;input.dataset.lng=pt.lng;
      autoCompute();
    });
  };
  [...list.querySelectorAll('input.stop')].forEach(attach);

  /* buttons */
  document.getElementById('add').onclick=()=>{
    if(list.children.length<labels.length){
      const r=makeRow(list.children.length);list.appendChild(r);
      attach(r.querySelector('.stop'));renumber();
    }
  };
  document.getElementById('route').onclick=rebuildRoute;
  document.getElementById('opt').onclick=globalOptimizeRoute;
};
/* fire immediately if Maps won the race */
if(window.__mapsApiReady)window.routePlannerInit();

/* debounce */
const schedule=(ms=250)=>{clearTimeout(autoTimer);autoTimer=setTimeout(autoCompute,ms);};

/* ────────────────── auto‑compute ────────────────── */
function autoCompute(){
  const rows=[...document.querySelectorAll('.row')],
        filled=rows.filter(r=>r.querySelector('.stop').value.trim()),
        msg=document.getElementById('msg');

  if(filled.length===0){
    clearPreviewPins();clearLegDisplays();msg.textContent='';
    reallyClearRoute();return;
  }

  ensureCoords(filled).then(()=>{
    clearPreviewPins();
    filled.forEach((r,i)=>{
      const inp=r.querySelector('.stop');
      if(inp.dataset.lat&&inp.dataset.lng){
        previewPins.push(new google.maps.Marker({
          map,position:{lat:+inp.dataset.lat,lng:+inp.dataset.lng},
          label:{text:labels[i],color:'#fff'}
        }));
      }
    });
    filled.length<2?reallyClearRoute():rebuildRoute();
  });
}

/* row->location helper */
const rowToLoc=r=>{
  const i=r.querySelector('.stop');
  return (i.dataset.lat&&i.dataset.lng)
    ? new google.maps.LatLng(+i.dataset.lat,+i.dataset.lng)
    : i.value.trim();
};

/* fixed‑order route */
function rebuildRoute(){
  const rows=[...document.querySelectorAll('.row')].filter(r=>r.querySelector('.stop').value.trim());
  const msg=document.getElementById('msg');
  clearLegDisplays();
  if(rows.length<2){msg.textContent='';reallyClearRoute();return;}

  const locs=rows.map(rowToLoc), thisReq=++routeVer;
  dirSvc.route({
    origin:locs[0],destination:locs[locs.length-1],
    waypoints:locs.slice(1,-1).map(l=>({location:l,stopover:true})),
    travelMode:'DRIVING'
  },(res,s)=>{if(thisReq===routeVer)displayLegs(res,s);});
}

/* ────────────────── FAST OPTIMIZER ────────────────── */
async function globalOptimizeRoute(){
  const msg=document.getElementById('msg'),list=document.getElementById('stops');
  const rows=[...list.querySelectorAll('.row')].filter(r=>r.querySelector('.stop').value.trim());
  if(rows.length<3){rebuildRoute();return;}

  await ensureCoords(rows);
  const locs=rows.map(rowToLoc), n=locs.length;
  msg.textContent='Optimizing…';routeVer++;const run=routeVer;

  new google.maps.DistanceMatrixService().getDistanceMatrix({
    origins:locs,destinations:locs,travelMode:'DRIVING',
    unitSystem:google.maps.UnitSystem.METRIC
  },(dm,stat)=>{
    if(run!==routeVer)return;
    if(stat!=='OK'){msg.textContent='Optimize failed';return;}

    /* distance matrix (metres) */
    const dist=dm.rows.map(r=>r.elements.map(e=>e.status==='OK'?e.distance.value:1e12));

    /* simple nearest‑neighbour heuristic from every start, keep best */
    let bestPath=null,bestLen=Infinity;
    for(let s=0;s<n;s++){
      const used=Array(n).fill(false);used[s]=true;
      const order=[s];let cur=s,total=0;
      for(let step=1;step<n;step++){
        let nxt=-1,best=1e12;
        for(let j=0;j<n;j++)if(!used[j]&&dist[cur][j]<best){best=dist[cur][j];nxt=j;}
        order.push(nxt);used[nxt]=true;total+=best;cur=nxt;
      }
      if(total<bestLen){bestLen=total;bestPath=order;}
    }

    /* re‑order DOM */
    const rowNodes=[...list.querySelectorAll('.row')];
    bestPath.forEach(i=>list.appendChild(rowNodes[i]));
    renumber();

    /* draw route in that order */
    const seqLocs=bestPath.map(i=>locs[i]);
    dirSvc.route({
      origin:seqLocs[0],destination:seqLocs[seqLocs.length-1],
      waypoints:seqLocs.slice(1,-1).map(l=>({location:l,stopover:true})),
      travelMode:'DRIVING'
    },(res,s)=>{
      if(s!=='OK'){msg.textContent='Route error';reallyClearRoute();return;}
      displayLegs(res,'OK');
      const km=res.routes[0].legs.reduce((a,l)=>a+l.distance.value,0)/1000;
      const mins=Math.round(res.routes[0].legs.reduce((a,l)=>a+l.duration.value,0)/60);
      msg.textContent=`Optimized distance ${km.toFixed(1)} km | ≈ ${mins} min`;
    });
  });
}

/* ────────────────── Leg summary ────────────────── */
function displayLegs(res,stat){
  const msg=document.getElementById('msg');
  if(stat!=='OK'){msg.textContent='Route error: '+stat;reallyClearRoute();return;}
  dirRend.setDirections(res);

  const rows=[...document.querySelectorAll('.row')];
  clearLegDisplays();

  let kmTot=0,minTot=0;
  res.routes[0].legs.forEach((leg,i)=>{
    const km=leg.distance.value/1000,min=Math.round(leg.duration.value/60);
    kmTot+=km;minTot+=min;
    const letter=rows[i]?.querySelector('.bullet')?.textContent.trim()||'';
    const cls=colours.includes(letter)?('leg-'+letter):'leg-default';
    const d=document.createElement('div');
    d.className='leg-display '+cls;
    d.textContent=`Distance ${km.toFixed(1)} km | ≈ ${min} min`;
    rows[i].after(d);
  });
  msg.textContent=`Total Distance ${kmTot.toFixed(1)} km | ≈ ${minTot} min`;
}
</script>
</body>
</html>
